<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>结果详情 - 信息溯源 (编号)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        .status-badge-lg { padding: 0.3rem 0.8rem; font-size: 0.8rem; border-radius: 0.375rem; font-weight: 500; }
        .status-pending { background-color: #fef3c7; color: #b45309; }
        .status-approved { background-color: #d1fae5; color: #047857; }
        .status-rejected { background-color: #fee2e2; color: #b91c1c; }
        .version-item.active { background-color: #e0f2fe; border-left-color: #0ea5e9; }
        .result-content-display { white-space: pre-wrap; word-wrap: break-word; line-height: 1.8; } 
        #original-doc-iframe { min-height: calc(100vh - 150px); }
        .pane-transition { transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }

        .inferred-highlight {
            /* Optional styling for the text part */
        }
        .source-ref {
            font-size: 0.7em; 
            font-weight: 600;
            padding: 0.5px 2.5px;
            border-radius: 3px;
            background-color: #e0e7ff; 
            color: #3730a3; 
            cursor: pointer;
            margin-left: 2px;
            vertical-align: super;
            line-height: 1; 
            position: relative; 
            transition: background-color 0.2s, color 0.2s;
        }
        .source-ref:hover, .source-ref:focus-visible {
            background-color: #3730a3; 
            color: white;
            outline: none;
        }
        .ref-tooltip {
            visibility: hidden;
            width: 320px;
            background-color: #2d3748; 
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 10px 12px;
            position: absolute;
            z-index: 60; 
            bottom: 160%; 
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;
            font-size: 0.8rem;
            line-height: 1.5;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            pointer-events: none; 
        }
        .source-ref:hover .ref-tooltip, .source-ref:focus-visible .ref-tooltip {
            visibility: visible;
            opacity: 1;
            pointer-events: auto;
        }
        .ref-tooltip::after { 
            content: ""; position: absolute; top: 100%; left: 50%;
            margin-left: -6px; border-width: 6px; border-style: solid;
            border-color: #2d3748 transparent transparent transparent;
        }
        .ref-tooltip strong { color: #a0aec0; display: block; margin-bottom: 3px;}
        .ref-tooltip a { color: #63b3ed; text-decoration: underline; }
        .ref-tooltip a:hover { color: #90cdf4; }
        .ref-tooltip .source-text-snippet { 
            display: block; background-color: #4a5568; padding: 5px; border-radius: 3px; margin-top: 4px;
            max-height: 60px; overflow-y: auto; font-style: italic; font-size: 0.75rem;
        }

        #source-list-panel { max-height: 200px; transition: max-height 0.3s ease-out; }
        #source-list-panel.collapsed { max-height: 0px !important; padding-top: 0 !important; padding-bottom: 0 !important; border-top-width: 0 !important; margin-bottom: 0 !important; overflow: hidden; }
        .source-list-item { cursor: pointer; padding: 6px 8px; border-radius: 4px; transition: background-color 0.2s; }
        .source-list-item:hover, .source-list-item.highlighted { background-color: #e0f2fe; } 
        .source-list-item .ref-number { font-weight: 600; color: #3730a3; }

        .pdf-highlight-overlay {
            position: absolute; background-color: rgba(255, 235, 59, 0.35); 
            border: 1.5px solid #FBC02D; box-sizing: border-box;
            pointer-events: none; z-index: 5; 
            transition: all 0.2s ease-out; border-radius: 2px;
        }
        .pdf-page-indicator { 
            position: absolute; top: 10px; right: 10px;
            background-color: rgba(0,0,0,0.65); color: white;
            padding: 4px 8px; font-size: 0.75rem;
            border-radius: 4px; z-index: 6;
            opacity: 0; transition: opacity 0.3s;
            pointer-events: none;
        }
        #right-pane:hover .pdf-page-indicator.visible-indicator {
             opacity: 1;
        }
    </style>
</head>
<body class="bg-slate-100 font-sans">
    <div class="flex flex-col h-screen">
        <header class="bg-white shadow-sm p-3 border-b border-slate-200 flex-shrink-0">
             <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center min-w-0">
                    <h1 id="result-main-title" class="text-lg font-semibold text-slate-800 truncate mr-4" title="结果详情: 加载中...">结果详情: 加载中...</h1>
                </div>
                <div class="flex items-center space-x-2" id="header-actions-buttons">
                    {/* Dynamic action buttons (Copy, Export, Review) will be prepended here by updateMainActions */}
                    <button id="toggle-original-doc-btn" title="切换原始文献显隐" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md flex items-center">
                        <i class="fas fa-eye-slash mr-1.5"></i> <span id="toggle-doc-text">隐藏原文</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 flex flex-col md:flex-row overflow-hidden p-3 gap-3">
            <div id="left-pane" class="w-full md:w-1/2 flex flex-col bg-white rounded-lg shadow overflow-hidden pane-transition">
                <div class="p-4 border-b border-slate-200 flex-shrink-0">
                    <div class="flex justify-between items-center mb-1">
                        <h2 class="text-base font-semibold text-slate-700">结果内容 
                            <span class="text-xs text-slate-400 font-normal">(点击<sup class="source-ref !bg-transparent !text-blue-500 !p-0 !font-bold">#</sup>查看来源)</span>
                        </h2>
                        <span id="result-status-badge" class="status-badge-lg">加载中</span>
                    </div>
                    <p id="result-version-info" class="text-xs text-slate-500">版本: - | 更新: -</p>
                </div>

                <div id="result-content-area" class="p-4 flex-grow overflow-y-auto custom-scrollbar">
                    <div id="result-text-display" class="text-sm text-slate-700 result-content-display">加载中...</div>
                    <textarea id="result-text-edit" class="hidden w-full h-full text-sm border border-slate-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 custom-scrollbar" rows="10" placeholder="在此编辑结果内容。使用 [[文本内容|refs:sourceId1,sourceId2]] 格式添加溯源。\n源定义在版本数据中，例如：s1, s2..."></textarea>
                </div>
                
                <div id="edit-specific-actions" class="p-3 border-t border-slate-200 bg-slate-50 hidden flex-shrink-0">
                     <div class="mb-2">
                         <label for="revision-notes" class="block text-xs font-medium text-slate-600 mb-1">修改说明 (可选)</label>
                         <input type="text" id="revision-notes" class="w-full text-xs p-1.5 border border-slate-300 rounded-md focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button id="cancel-edit-btn" class="px-3 py-1.5 text-xs font-medium text-slate-700 bg-slate-200 hover:bg-slate-300 rounded-md">取消</button>
                        <button id="save-changes-btn" class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">保存修改</button>
                        <button id="approve-result-btn" class="px-3 py-1.5 text-xs font-medium text-white bg-green-600 hover:bg-green-700 rounded-md">审核通过</button>
                    </div>
                </div>
                
                <div id="source-list-panel-wrapper" class="flex-shrink-0 border-t border-slate-200">
                    <button id="toggle-source-list-btn" class="w-full text-left p-2 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 focus:outline-none flex justify-between items-center">
                        <span>参考文献/来源列表</span>
                        <i id="source-list-caret" class="fas fa-chevron-up transition-transform"></i> {/* Default to up, meaning panel is collapsed */}
                    </button>
                    <div id="source-list-panel" class="p-3 bg-slate-50 overflow-y-auto custom-scrollbar collapsed">
                        <ul id="source-list-ul" class="text-xs space-y-1.5">
                            <li class="text-slate-400 italic">暂无来源信息或未加载。</li>
                        </ul>
                    </div>
                </div>

                <div class="p-3 border-t border-slate-200 bg-slate-50/50 flex-shrink-0 max-h-48 overflow-y-auto custom-scrollbar">
                    <h3 class="text-sm font-semibold text-slate-600 mb-2">修改历史</h3>
                    <ul id="version-history-list" class="space-y-1.5 text-xs">
                        <li class="text-slate-500">加载中...</li>
                    </ul>
                </div>
            </div>

            <div id="right-pane" class="w-full md:w-1/2 bg-white rounded-lg shadow overflow-hidden flex flex-col pane-transition relative">
                <div class="p-3 border-b border-slate-200 bg-slate-50 flex justify-between items-center flex-shrink-0">
                    <h2 class="text-base font-semibold text-slate-700">原始文献</h2>
                </div>
                <div class="p-1 flex-grow custom-scrollbar overflow-auto relative bg-slate-200">
                    <iframe id="original-doc-iframe" src="" class="w-full h-full border-none" title="Original Document"></iframe>
                    <div id="pdf-highlight-overlay" class="pdf-highlight-overlay hidden"></div>
                    <div id="pdf-page-indicator" class="pdf-page-indicator">Page ?</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Mock Data ---
        const mockResultDetailsStore = {
            "res001": { 
                name: "白芍文献1的有效成分及药理作用分析结果", status: "approved", 
                originalDocUrl: "https://www.africau.edu/images/default/sample.pdf", currentVersion: "v1.3",
                versions: [
                     { version: "v1.3", date: "2025-02-20", editor: "张三", notes: "更新为编号引用格式", 
                       content: "文献明确指出[[白芍总苷具有显著的抗炎、镇痛双重药理作用|refs:s1]]。其主要活性成分包括[[芍药苷|refs:s1]]和羟基芍药苷等。这些发现与[[一项重要的外部研究|refs:s2]]的结果相符。因此，综合来看，[[白芍作为传统中药，其药用价值得到了现代药理学的支持|refs:s3]]。这句话同时参考了[[文献和外部链接|refs:s1,s2]]。",
                       sources: {
                            "s1": { type: "doc", page: 2, rect: "50,100,300,40", sel: "段落开头'白芍总苷...'", displayText: "本文献，第 2 页，高亮区域", docSnippet: "白芍总苷具有显著的抗炎、镇痛双重药理作用，对多种炎症模型均显示出良好的抑制效果..." },
                            "s2": { type: "url", link: "https://pubmed.ncbi.nlm.nih.gov/12345678/", displayText: "外部研究: PubMed ID 12345678" },
                       }, approved: true },
                    { version: "v1.2", date: "2025-02-18", editor: "张三", notes: "添加了旧版溯源信息", content: "文献指出 [[白芍总苷具有抗炎、镇痛作用|source:doc,page:2,rect:50,100,200,30]]。", sources:{}, approved: true }, // Old version might not have new sources structure
                    { version: "v1.1", date: "2025-02-16", editor: "张三", notes: "最终审核通过版 (无溯源)", content: "详细分析结果内容 v1.1...\n- 白芍总苷具有抗炎、镇痛作用。", sources:{}, approved: true },
                ]
            },
            "res002": { name: "白芍文献2的核心观点提炼", status: "pending", originalDocUrl: "https://www.clickdimensions.com/links/TestPDFfile.pdf", currentVersion: "v1.1", versions: [{ version: "v1.1", date: "2025-02-19", editor: "赵六", notes: "更新引用", content: "核心观点：[[白芍有免疫调节价值|refs:srcA]]。需要[[进一步验证|refs:srcB]]。", sources: {"srcA": {type:"doc", page:1, displayText:"本文献第1页"}, "srcB": {type:"reason", text:"文献结论部分提及需要更多实验", displayText:"推理: 文献结论"}}, approved: false }] },
        };
        
        // --- DOM Elements ---
        let currentResultId = null, currentResultData = null, displayedVersion = null, isEditMode = false, isOriginalDocVisible = true;
        const resultMainTitle = document.getElementById('result-main-title'), resultStatusBadge = document.getElementById('result-status-badge'), resultVersionInfo = document.getElementById('result-version-info'), resultTextDisplay = document.getElementById('result-text-display'), resultTextEdit = document.getElementById('result-text-edit'), editSpecificActions = document.getElementById('edit-specific-actions'), revisionNotesInput = document.getElementById('revision-notes'), headerActionsButtons = document.getElementById('header-actions-buttons'), versionHistoryList = document.getElementById('version-history-list'), originalDocIframe = document.getElementById('original-doc-iframe'), leftPane = document.getElementById('left-pane'), rightPane = document.getElementById('right-pane'), toggleOriginalDocBtn = document.getElementById('toggle-original-doc-btn'), toggleDocText = document.getElementById('toggle-doc-text'), toggleDocIcon = toggleOriginalDocBtn.querySelector('i'), pdfHighlightOverlay = document.getElementById('pdf-highlight-overlay'), pdfPageIndicator = document.getElementById('pdf-page-indicator'), sourceListUL = document.getElementById('source-list-ul'), toggleSourceListBtn = document.getElementById('toggle-source-list-btn'), sourceListCaret = document.getElementById('source-list-caret'), sourceListPanel = document.getElementById('source-list-panel');

        function getStatusBadgeHTML(status) { /* ... (same) ... */ 
             let badgeClass = '';
            let statusText = status;
            switch (status) {
                case 'pending': badgeClass = 'status-pending'; statusText = '待审核'; break;
                case 'approved': badgeClass = 'status-approved'; statusText = '审核通过'; break;
                case 'rejected': badgeClass = 'status-rejected'; statusText = '审核不通过'; break;
                default: badgeClass = 'bg-slate-200 text-slate-700'; break;
            }
            return `<span class="status-badge-lg ${badgeClass}">${statusText}</span>`;
        }
        function escapeHtml(unsafe) { /* ... (same) ... */ 
            if (typeof unsafe !== 'string') return '';
            return unsafe.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">").replace(/"/g, """).replace(/'/g, "'");
        }

        function parseSourcedContentWithRefs(rawContent, sources = {}) {
            const regex = /\[\[(.*?)\|refs:([a-zA-Z0-9_,-]+)\]\]/g; // Allow underscore in ref IDs
            let resultHTML = "";
            let lastIndex = 0;
            const sourceIdToNumberMap = {};
            let currentRefNumber = 1;

            for (const match of rawContent.matchAll(regex)) {
                const refIdsString = match[2].trim();
                refIdsString.split(',').forEach(refId => {
                    const cleanedRefId = refId.trim(); 
                    if (sources[cleanedRefId] && !sourceIdToNumberMap[cleanedRefId]) {
                        sourceIdToNumberMap[cleanedRefId] = currentRefNumber++;
                    }
                });
            }

            for (const match of rawContent.matchAll(regex)) {
                const textBefore = rawContent.substring(lastIndex, match.index);
                const inferredText = match[1].trim();
                const refIdsString = match[2].trim();
                
                resultHTML += escapeHtml(textBefore); 
                resultHTML += `<span class="inferred-highlight">${escapeHtml(inferredText)}</span>`;

                const refIdArray = refIdsString.split(',').map(id => id.trim());

                refIdArray.forEach((refId, idx) => {
                    const source = sources[refId];
                    if (!source) return;
                    const refNum = sourceIdToNumberMap[refId];
                    if (!refNum) return;
                    
                    resultHTML += `<sup class="source-ref" role="button" tabindex="0" aria-label="查看来源 ${refNum}" data-ref-id="${escapeHtml(refId)}">${refNum}</sup>`;
                    if (idx < refIdArray.length - 1) resultHTML += ','; 
                });
                lastIndex = match.index + match[0].length;
            }
            resultHTML += escapeHtml(rawContent.substring(lastIndex));
            return { html: resultHTML, numberedSources: sourceIdToNumberMap };
        }

        function displayVersionContent(versionObj) {
            displayedVersion = versionObj;
            const sourcesForVersion = versionObj.sources || {}; 
            const { html: parsedHtml, numberedSources } = parseSourcedContentWithRefs(versionObj.content || "", sourcesForVersion);
            
            resultTextDisplay.innerHTML = parsedHtml;
            resultVersionInfo.textContent = `版本: ${versionObj.version} | 更新: ${versionObj.date} by ${versionObj.editor}`;
            if (versionObj.notes) resultVersionInfo.textContent += ` | 说明: ${versionObj.notes}`;
            
            if (isEditMode && currentResultData && currentResultData.versions && displayedVersion.version !== currentResultData.versions[0].version) {
                toggleEditMode(false); 
            }
            resultTextEdit.value = versionObj.content || ""; 
            renderSourceList(sourcesForVersion, numberedSources);
            attachSourceRefListeners(sourcesForVersion);
        }
        
        function renderSourceList(sources, numberedSourcesMap) { /* ... (same) ... */ 
             sourceListUL.innerHTML = '';
            if (Object.keys(sources).length === 0 || Object.keys(numberedSourcesMap).length === 0) {
                sourceListUL.innerHTML = `<li class="text-slate-400 italic">当前结果版本无引用来源。</li>`;
                return;
            }
            const sortedSourceEntries = Object.entries(sources)
                .filter(([id, _]) => numberedSourcesMap[id]) 
                .sort(([idA, _A], [idB, _B]) => numberedSourcesMap[idA] - numberedSourcesMap[idB]);

            sortedSourceEntries.forEach(([id, source]) => {
                const refNum = numberedSourcesMap[id];
                const li = document.createElement('li');
                li.className = 'source-list-item';
                li.setAttribute('data-ref-id', id);
                li.innerHTML = `<span class="ref-number">[${refNum}]</span> ${escapeHtml(source.displayText || `${source.type} source`)}`;
                li.addEventListener('click', () => handleSourceInteraction(source));
                sourceListUL.appendChild(li);
            });
        }
        
        function attachSourceRefListeners(sources) { /* ... (same, using wrapper functions) ... */
            document.querySelectorAll('.source-ref').forEach(el => {
                const refId = el.dataset.refId; 
                const source = sources[refId]; 

                el.removeEventListener('click', sourceRefClickHandlerWrapper);
                el.removeEventListener('keydown', sourceRefKeydownHandlerWrapper);
                el.removeEventListener('mouseenter', sourceRefMouseenterHandlerWrapper);
                el.removeEventListener('mouseleave', sourceRefMouseleaveHandler);
                el.removeEventListener('focus', sourceRefMouseenterHandlerWrapper); 
                el.removeEventListener('blur', sourceRefMouseleaveHandler);  

                if (source) {
                    el.sourceDataForHandler = source; 
                    el.refNumberForHandler = el.textContent; 

                    el.addEventListener('click', sourceRefClickHandlerWrapper);
                    el.addEventListener('keydown', sourceRefKeydownHandlerWrapper);
                    el.addEventListener('mouseenter', sourceRefMouseenterHandlerWrapper);
                    el.addEventListener('mouseleave', sourceRefMouseleaveHandler);
                    el.addEventListener('focus', sourceRefMouseenterHandlerWrapper);
                    el.addEventListener('blur', sourceRefMouseleaveHandler);
                }
            });
         }
        function sourceRefClickHandlerWrapper(event) { handleSourceInteraction(event.currentTarget.sourceDataForHandler); }
        function sourceRefKeydownHandlerWrapper(event) { if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); handleSourceInteraction(event.currentTarget.sourceDataForHandler); } }
        function sourceRefMouseenterHandlerWrapper(event) { showRefTooltip(event.currentTarget, event.currentTarget.sourceDataForHandler, event.currentTarget.refNumberForHandler); }
        
        let currentTooltip = null;
        function showRefTooltip(element, source, refNum) { /* ... (same) ... */ 
            if (!source) return; 
            if (currentTooltip) currentTooltip.remove(); 

            let tooltipText = `<strong>源 #${refNum}:</strong> ${escapeHtml(source.displayText) || source.type}<br>`;
            if (source.type === 'doc' && source.docSnippet) {
                tooltipText += `<span class="source-text-snippet">${escapeHtml(source.docSnippet)}</span>`;
            } else if (source.type === 'url' && source.link) { 
                tooltipText += `<a href='${escapeHtml(source.link)}' target='_blank' rel='noopener noreferrer'>${escapeHtml(source.link)}</a>`;
            } else if (source.type === 'reason' && source.text) { 
                tooltipText += `<em>${escapeHtml(source.text)}</em>`;
            }

            currentTooltip = document.createElement('div');
            currentTooltip.className = 'ref-tooltip'; 
            currentTooltip.innerHTML = tooltipText; 
            
            element.appendChild(currentTooltip); 
            currentTooltip.style.visibility = 'visible'; 
            currentTooltip.style.opacity = '1';
        }
        function hideRefTooltip() { /* ... (same) ... */ 
             if (currentTooltip) {
                currentTooltip.style.opacity = '0';
                currentTooltip.style.visibility = 'hidden';
                setTimeout(() => { if (currentTooltip && currentTooltip.style.opacity === '0') currentTooltip.remove(); currentTooltip = null; }, 200);
            }
        }
        function sourceRefMouseleaveHandler() { hideRefTooltip(); }


        function handleSourceInteraction(source) { /* ... (same) ... */ 
            if (!source) return;
            pdfHighlightOverlay.classList.add('hidden');
            pdfPageIndicator.classList.remove('visible-indicator');

            document.querySelectorAll('#source-list-ul .source-list-item.highlighted').forEach(li => li.classList.remove('highlighted'));
            const sourceIdToHighlight = displayedVersion && displayedVersion.sources ? Object.keys(displayedVersion.sources).find(key => displayedVersion.sources[key] === source) : null;
            if (sourceIdToHighlight) {
                const listItem = sourceListUL.querySelector(`[data-ref-id="${sourceIdToHighlight}"]`);
                if (listItem) {
                     listItem.classList.add('highlighted');
                     listItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }

            if (source.type === 'doc') {
                if (isOriginalDocVisible === false) toggleOriginalDocPane();
                if (source.page) {
                    pdfPageIndicator.textContent = `Page ${source.page}`;
                    pdfPageIndicator.classList.add('visible-indicator');
                    console.log(`Simulating navigation to PDF page: ${source.page}`);
                }
                if (source.rect) { 
                    const rect = source.rect.split(',').map(Number);
                    pdfHighlightOverlay.style.left = `${rect[0]}px`; 
                    pdfHighlightOverlay.style.top = `${rect[1]}px`;  
                    pdfHighlightOverlay.style.width = `${rect[2]}px`;
                    pdfHighlightOverlay.style.height = `${rect[3]}px`;
                    pdfHighlightOverlay.classList.remove('hidden');
                }
                rightPane.style.boxShadow = "0 0 15px 5px rgba(59, 130, 246, 0.4)";
                setTimeout(() => { rightPane.style.boxShadow = ""; }, 1500);
            } else if (source.type === 'url') {
                if (source.link) window.open(source.link, '_blank');
            } else if (source.type === 'reason') {
                if (source.text) alert(`推理依据:\n${source.text}`);
            }
        }
        
        function renderVersionHistory() { /* ... (same) ... */  
            versionHistoryList.innerHTML = '';
            if (!currentResultData || !currentResultData.versions) return;
            currentResultData.versions.forEach(v => {
                const li = document.createElement('li');
                li.className = `p-1.5 rounded-md hover:bg-slate-100 cursor-pointer border-l-2 border-transparent version-item ${displayedVersion && v.version === displayedVersion.version ? 'active' : ''}`;
                li.innerHTML = `<div class="font-medium text-slate-700">版本 ${v.version} <span class="text-xs text-slate-500 font-normal">- ${v.date}</span></div>${v.notes ? `<div class="text-slate-500 truncate" title="${v.notes}">${v.notes}</div>` : ''}`;
                li.onclick = () => {
                    displayVersionContent(v);
                    document.querySelectorAll('#version-history-list .version-item.active').forEach(item => item.classList.remove('active'));
                    li.classList.add('active');
                };
                versionHistoryList.appendChild(li);
            });
        }
        function updateMainActions() { /* ... (same) ... */ 
            const dynamicActionsContainer = document.getElementById('dynamic-actions-placeholder') || document.createElement('div');
            dynamicActionsContainer.id = 'dynamic-actions-placeholder';
            dynamicActionsContainer.className = 'flex items-center space-x-2';
            dynamicActionsContainer.innerHTML = ''; 

            const copyBtnHtml = `<button id="copy-result-btn" title="复制当前结果纯文本(含溯源标记)" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md flex items-center"><i class="fas fa-copy mr-1.5"></i>复制</button>`;
            const exportBtnHtml = `<button id="export-result-btn" title="导出当前结果" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md flex items-center"><i class="fas fa-file-export mr-1.5"></i>导出</button>`;
            dynamicActionsContainer.innerHTML += copyBtnHtml + exportBtnHtml;

            if (currentResultData && currentResultData.status !== 'approved' && !isEditMode) {
                 const reviewBtnHtml = `<button id="review-edit-btn" class="px-3 py-1.5 text-sm font-medium text-white bg-orange-500 hover:bg-orange-600 rounded-md flex items-center"><i class="fas fa-edit mr-1.5"></i>审核/编辑</button>`;
                 dynamicActionsContainer.innerHTML += reviewBtnHtml;
            }
            
            const existingPlaceholder = headerActionsButtons.querySelector('#dynamic-actions-placeholder');
            if (existingPlaceholder) {
                headerActionsButtons.replaceChild(dynamicActionsContainer, existingPlaceholder);
            } else {
                headerActionsButtons.insertBefore(dynamicActionsContainer, toggleOriginalDocBtn);
            }

            if(document.getElementById('copy-result-btn')) {
                document.getElementById('copy-result-btn').onclick = () => { 
                    const rawTextWithMarkup = displayedVersion ? displayedVersion.content : resultTextEdit.value;
                    navigator.clipboard.writeText(rawTextWithMarkup)
                    .then(() => alert('结果内容 (含溯源标记) 已复制!'))
                    .catch(err => console.error('复制失败:', err));
                };
            }
            if(document.getElementById('export-result-btn')) {
                document.getElementById('export-result-btn').onclick = () => alert('导出功能 (占位)');
            }
            if(document.getElementById('review-edit-btn')) {
                 document.getElementById('review-edit-btn').onclick = () => toggleEditMode(true);
            }
        }
        function toggleEditMode(enable) { /* ... (same) ... */ 
             isEditMode = enable;
            if (enable) {
                if (!displayedVersion || !currentResultData || !currentResultData.versions || displayedVersion.version !== currentResultData.versions[0].version) {
                    alert("只能编辑最新版本的结果。");
                    isEditMode = false; 
                    return;
                }
                resultTextDisplay.classList.add('hidden');
                resultTextEdit.classList.remove('hidden');
                resultTextEdit.value = displayedVersion.content; 
                resultTextEdit.focus();
                editSpecificActions.classList.remove('hidden');
            } else {
                resultTextDisplay.classList.remove('hidden');
                resultTextEdit.classList.add('hidden');
                editSpecificActions.classList.add('hidden');
                if(displayedVersion) displayVersionContent(displayedVersion); 
            }
            updateMainActions(); 
        }
        function toggleOriginalDocPane() { /* ... (same) ... */ 
             isOriginalDocVisible = !isOriginalDocVisible;
            if (isOriginalDocVisible) {
                rightPane.classList.remove('hidden', 'md:w-0', 'opacity-0');
                rightPane.classList.add('md:w-1/2');
                leftPane.classList.remove('md:w-full');
                leftPane.classList.add('md:w-1/2');
                toggleDocText.textContent = '隐藏原文';
                toggleDocIcon.classList.remove('fa-eye');
                toggleDocIcon.classList.add('fa-eye-slash');

            } else {
                rightPane.classList.add('hidden', 'md:w-0', 'opacity-0');
                rightPane.classList.remove('md:w-1/2');
                leftPane.classList.add('md:w-full');
                leftPane.classList.remove('md:w-1/2');
                toggleDocText.textContent = '显示原文';
                toggleDocIcon.classList.remove('fa-eye-slash');
                toggleDocIcon.classList.add('fa-eye');
                pdfHighlightOverlay.classList.add('hidden'); 
                pdfPageIndicator.classList.remove('visible-indicator');
            }
        }
        
        if (toggleSourceListBtn) {
            toggleSourceListBtn.addEventListener('click', () => {
                sourceListPanel.classList.toggle('collapsed');
                sourceListCaret.classList.toggle('fa-chevron-down');
                sourceListCaret.classList.toggle('fa-chevron-up');
                // No need to set max-height with JS if using `!important` in CSS for collapsed state
            });
        }

        function loadResultDetails(resultId) { /* ... (same, ensure it handles new data structure) ... */ 
            currentResultId = resultId;
            currentResultData = mockResultDetailsStore[resultId];

            if (!currentResultData) {
                resultMainTitle.textContent = "结果详情: 未找到";
                resultMainTitle.title = "结果详情: 未找到";
                resultTextDisplay.innerHTML = "<p class='text-red-500'>无法加载结果详情。</p>";
                sourceListUL.innerHTML = `<li class="text-slate-400 italic">无法加载来源信息。</li>`;
                updateMainActions(); 
                return;
            }

            resultMainTitle.textContent = `结果详情: ${currentResultData.name}`;
            resultMainTitle.title = `结果详情: ${currentResultData.name}`;
            resultStatusBadge.innerHTML = getStatusBadgeHTML(currentResultData.status);
            originalDocIframe.src = currentResultData.originalDocUrl || "about:blank";

            if (currentResultData.versions && currentResultData.versions.length > 0) {
                displayVersionContent(currentResultData.versions[0]); 
                renderVersionHistory();
            } else {
                resultTextDisplay.innerHTML = "<p class='text-slate-500'>此结果没有版本信息。</p>";
                sourceListUL.innerHTML = `<li class="text-slate-400 italic">无版本信息，无法加载来源。</li>`;
                versionHistoryList.innerHTML = `<li class="text-slate-500 italic">无历史版本。</li>`;
            }
            updateMainActions();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // ... (DOMContentLoaded logic for URL params, save, approve, cancel - same as before) ...
            const urlParams = new URLSearchParams(window.location.search);
            const resultIdFromUrl = urlParams.get('id');
            if (resultIdFromUrl) {
                loadResultDetails(decodeURIComponent(resultIdFromUrl));
            } else {
                resultMainTitle.textContent = "结果详情: 无效ID";
                resultMainTitle.title = "结果详情: 无效ID";
                updateMainActions(); 
            }
            if(toggleOriginalDocBtn) toggleOriginalDocBtn.addEventListener('click', toggleOriginalDocPane);

            if(document.getElementById('cancel-edit-btn')) document.getElementById('cancel-edit-btn').onclick = () => toggleEditMode(false);
            
            if(document.getElementById('save-changes-btn')) document.getElementById('save-changes-btn').onclick = () => { 
                const newRawContentWithMarkup = resultTextEdit.value; 
                const notes = revisionNotesInput.value || "内容更新 (含溯源)";
                const currentDate = new Date().toISOString().split('T')[0];
                const currentUser = "当前用户"; 

                const latestVersionNum = (currentResultData && currentResultData.versions.length > 0) ? parseFloat(currentResultData.versions[0].version.substring(1)) : 0;
                const newVersionNum = (latestVersionNum + 0.1).toFixed(1);

                const newVersion = {
                    version: `v${newVersionNum}`, date: currentDate, editor: currentUser, notes: notes,
                    content: newRawContentWithMarkup, 
                    sources: (displayedVersion && displayedVersion.sources) ? JSON.parse(JSON.stringify(displayedVersion.sources)) : {}, // Deep copy sources
                    approved: false 
                };
                if (!currentResultData.versions) currentResultData.versions = [];
                currentResultData.versions.unshift(newVersion); 
                currentResultData.status = 'pending'; 
                mockResultDetailsStore[currentResultId] = currentResultData;

                displayVersionContent(newVersion);
                renderVersionHistory();
                resultStatusBadge.innerHTML = getStatusBadgeHTML(currentResultData.status);
                revisionNotesInput.value = '';
                toggleEditMode(false);
                alert('修改已保存 (含溯源信息)，状态更新为待审核!');
            };

            if(document.getElementById('approve-result-btn')) document.getElementById('approve-result-btn').onclick = () => { 
                const latestVersionToApprove = currentResultData.versions[0];
                if (!latestVersionToApprove) { alert("没有可批准的版本！"); return; }
                
                if (resultTextEdit.value !== latestVersionToApprove.content && isEditMode) {
                    if (!confirm("内容已修改但未保存。是否先保存更改再审核通过？\n点击 '确定' 保存并审核。\n点击 '取消' 以当前版本内容直接审核。")) {
                        latestVersionToApprove.content = resultTextEdit.value; 
                        latestVersionToApprove.notes = revisionNotesInput.value || "审核时直接更新内容并通过";
                    } else { 
                         latestVersionToApprove.content = resultTextEdit.value;
                         latestVersionToApprove.notes = revisionNotesInput.value || "保存并审核通过";
                    }
                }
                latestVersionToApprove.approved = true;
                latestVersionToApprove.rejected = false;
                latestVersionToApprove.date = new Date().toISOString().split('T')[0];
                latestVersionToApprove.editor = "审核人 (模拟)"; 
                currentResultData.status = 'approved';
                mockResultDetailsStore[currentResultId] = currentResultData;

                displayVersionContent(latestVersionToApprove);
                renderVersionHistory();
                resultStatusBadge.innerHTML = getStatusBadgeHTML(currentResultData.status);
                revisionNotesInput.value = '';
                toggleEditMode(false); 
                alert('结果已审核通过!');
            };
            
            // Initialize source list panel state
            if (sourceListPanel) { // Check if element exists
                if (!sourceListPanel.classList.contains('collapsed')) {
                    // If not explicitly collapsed and has scrollHeight, set maxHeight for animation
                    if (sourceListPanel.scrollHeight > 0) sourceListPanel.style.maxHeight = sourceListPanel.scrollHeight + "px";
                    else sourceListPanel.style.maxHeight = "200px"; // Default open height if no content yet
                    sourceListCaret.classList.remove('fa-chevron-up');
                    sourceListCaret.classList.add('fa-chevron-down');
                } else {
                    sourceListPanel.style.maxHeight = '0px';
                    sourceListCaret.classList.remove('fa-chevron-down');
                    sourceListCaret.classList.add('fa-chevron-up');
                }
            }
        });
    </script>
</body>
</html>