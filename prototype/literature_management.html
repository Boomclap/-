<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文献管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        .table-fixed-layout { table-layout: fixed; }
        .action-menu {
            position: absolute;
            right: 0;
            top: 100%; /* Position below the toggle button */
            margin-top: 0.25rem; /* 4px */
            z-index: 20; /* Ensure it's above table content */
        }
        .status-badge { padding: 0.25rem 0.6rem; font-size: 0.75rem; border-radius: 9999px; font-weight: 500; }
        .status-unprocessed { background-color: #f3f4f6; color: #4b5563; } 
        .status-processing { background-color: #fef3c7; color: #b45309; } 
        .status-analyzed { background-color: #d1fae5; color: #047857; } 
        .status-error { background-color: #fee2e2; color: #b91c1c; } 
        .conditional-btn { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out, visibility 0.3s; }
        .truncate-2-lines {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* 上传对话框样式 */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .dialog-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .dialog-content {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .dialog-overlay.active .dialog-content {
            transform: translateY(0);
            opacity: 1;
        }

        /* 其他样式从 upload_literature_dialog.html 复制 */
        .tag-input-container {
            position: relative;
        }

        .tag-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
        }

        .selected-tag {
            display: inline-flex;
            align-items: center;
            background-color: #e0f2fe;
            color: #0369a1;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            margin: 0.25rem;
            font-size: 0.875rem;
        }

        .folder-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-slate-100 font-sans p-4 md:p-6">
    <div class="container mx-auto">
        <header class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <h1 class="text-2xl font-semibold text-slate-800">文献管理</h1>
            <div class="flex items-center space-x-2 flex-wrap gap-y-2">
                <button id="batch-analysis-btn" class="conditional-btn hidden opacity-0 transform scale-95 px-3 py-2 text-sm bg-purple-500 text-white rounded-md hover:bg-purple-600 flex items-center"><i class="fas fa-cogs mr-1.5"></i> 批量调研</button>
                <button id="comprehensive-analysis-btn" class="conditional-btn hidden opacity-0 transform scale-95 px-3 py-2 text-sm bg-indigo-500 text-white rounded-md hover:bg-indigo-600 flex items-center"><i class="fas fa-microscope mr-1.5"></i> 综合调研</button>
                <button id="upload-literature-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-3 text-sm rounded-md flex items-center shadow-sm"> 
                    <i class="fas fa-upload mr-2"></i> 上传文献
                </button>
            </div>
        </header>

        <div class="bg-white p-4 sm:p-6 rounded-lg shadow mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="search-literature" class="block text-sm font-medium text-slate-700 mb-1">搜索文献</label>
                    <div class="relative">
                        <input type="text" id="search-literature" placeholder="标题、作者、关键词..." class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                        <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                    </div>
                </div>
                <div>
                    <label for="tag-filter-lit" class="block text-sm font-medium text-slate-700 mb-1">标签筛选</label>
                    <select id="tag-filter-lit" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm bg-white">
                        <option value="">所有标签</option>
                        <option value="IBD">IBD</option>
                        <option value="药材">药材</option>
                        <option value="临床研究">临床研究</option>
                        <option value="综述">综述</option>
                        <option value="化学">化学</option>
                        <option value="药理">药理</option>
                    </select>
                </div>
                 <div>
                    <label for="status-filter-lit" class="block text-sm font-medium text-slate-700 mb-1">状态筛选</label>
                    <select id="status-filter-lit" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm bg-white">
                        <option value="">所有状态</option>
                        <option value="unprocessed">未处理</option>
                        <option value="processing">处理中</option>
                        <option value="analyzed">已分析</option>
                        <option value="error">错误</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow overflow-x-auto custom-scrollbar">
            <table class="w-full min-w-[1200px] text-sm text-left text-slate-500 table-fixed-layout">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                    <tr>
                        <th scope="col" class="p-3 w-12"><input type="checkbox" id="select-all-literature" class="form-checkbox h-4 w-4 text-blue-600 border-slate-300 rounded accent-blue-600"></th>
                        <th scope="col" class="p-3 w-[20%]">标题</th>
                        <th scope="col" class="p-3 w-[12%]">作者</th>
                        <th scope="col" class="p-3 w-[15%]">关键词</th>
                        <th scope="col" class="p-3 w-[12%]">来源</th>
                        <th scope="col" class="p-3 w-[10%]">上传日期</th>
                        <th scope="col" class="p-3 w-[12%]">标签</th>
                        <th scope="col" class="p-3 w-24">状态</th>
                        <th scope="col" class="p-3 w-28 text-center">操作</th>
                    </tr>
                </thead>
                <tbody id="literature-table-body">
                    <!-- Rows populated by JS -->
                </tbody>
            </table>
        </div>
        
        <div id="lit-pagination-controls" class="mt-6 flex justify-center items-center space-x-1">
            <!-- Pagination populated by JS -->
        </div>
    </div>

    <!-- 上传文献对话框 -->
    <div id="upload-dialog" class="dialog-overlay">
        <div class="dialog-content">
            <!-- 对话框标题 -->
            <div class="flex justify-between items-center p-4 border-b border-slate-200">
                <h2 class="text-lg font-semibold text-slate-800">添加文献</h2>
                <button class="text-slate-400 hover:text-slate-500" onclick="closeDialog()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- 对话框内容 -->
            <div class="p-4 flex-1 overflow-y-auto custom-scrollbar">
                <!-- 文件上传区域 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-1">文献上传</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <i class="fas fa-cloud-upload-alt text-slate-400 text-3xl mb-3"></i>
                            <div class="flex text-sm text-slate-600">
                                <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                                    <span>选择文件</span>
                                    <input id="file-upload" name="file-upload" type="file" class="sr-only" accept=".pdf,.doc,.docx">
                                </label>
                                <p class="pl-1">或拖拽文件到这里</p>
                            </div>
                            <p class="text-xs text-slate-500">支持 PDF、Word 文档</p>
                        </div>
                    </div>
                </div>

                <!-- 所属文件夹选择 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-1">所属文件夹</label>
                    <div class="relative">
                        <input type="text" id="folder-input" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="输入以搜索文件夹...">
                        <div id="folder-suggestions" class="folder-suggestions hidden">
                            <!-- 文件夹建议将通过 JavaScript 动态添加 -->
                        </div>
                    </div>
                </div>

                <!-- 文献标签选择 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-slate-700 mb-1">文献标签</label>
                    <div class="tag-input-container">
                        <div class="flex flex-wrap p-2 border border-slate-300 rounded-md mb-2 min-h-[42px]" id="selected-tags">
                            <!-- 已选标签将通过 JavaScript 动态添加 -->
                        </div>
                        <div class="flex space-x-2">
                            <input type="text" id="tag-input" class="flex-1 p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="输入以搜索标签...">
                            <button onclick="showAddTagDialog()" class="px-3 py-2 bg-slate-100 text-slate-600 rounded-md hover:bg-slate-200">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="tag-suggestions" class="tag-suggestions hidden">
                            <!-- 标签建议将通过 JavaScript 动态添加 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 对话框底部按钮 -->
            <div class="flex justify-end space-x-2 p-4 border-t border-slate-200">
                <button onclick="closeDialog()" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-md hover:bg-slate-50">
                    取消
                </button>
                <button onclick="submitUpload()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                    确定
                </button>
            </div>
        </div>
    </div>

    <!-- 添加标签对话框 -->
    <div id="add-tag-dialog" class="dialog-overlay">
        <div class="dialog-content" style="max-width: 400px;">
            <div class="flex justify-between items-center p-4 border-b border-slate-200">
                <h3 class="text-lg font-semibold text-slate-800">添加新标签</h3>
                <button class="text-slate-400 hover:text-slate-500" onclick="closeAddTagDialog()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="mb-4">
                    <label for="new-tag-name" class="block text-sm font-medium text-slate-700 mb-1">标签名</label>
                    <input type="text" id="new-tag-name" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入标签名">
                </div>
                <div class="mb-4">
                    <label for="new-tag-desc" class="block text-sm font-medium text-slate-700 mb-1">标签描述（可选）</label>
                    <textarea id="new-tag-desc" rows="3" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="请输入标签描述..."></textarea>
                </div>
            </div>
            <div class="flex justify-end space-x-2 p-4 border-t border-slate-200">
                <button onclick="closeAddTagDialog()" class="px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-md hover:bg-slate-50">
                    取消
                </button>
                <button onclick="submitNewTag()" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                    确定
                </button>
            </div>
        </div>
    </div>

    <script>
        const mockLiteratureData = [
            { id: "lit001", title: "IBD最新研究进展与未来展望.pdf", authors: "王明, 李静", keywords: ["炎症性肠病", "治疗", "靶点", "免疫"], source: "中华医学杂志", uploadDate: "2024-03-10", tags: ["IBD", "综述"], status: "analyzed", originalDocUrl: "sample_doc1.pdf", articleType: "综述文章", publishYear: "2024", volume: "104", issue: "5", impactFactor: "3.567", doi: "10.3760/cma.j.cn112137-20231010-00123", abstractText: "炎症性肠病（IBD）是一组慢性、复发性肠道炎症性疾病...", citationsText: "Baumgart DC, Sandborn WJ. Crohn's disease. Lancet. 2012" },
            { id: "lit002", title: "白芍化学成分及其抗炎活性研究.docx", authors: "张伟", keywords: ["白芍", "芍药苷", "抗炎", "天然产物"], source: "中草药", uploadDate: "2024-03-12", tags: ["药材", "白芍", "化学"], status: "processing", originalDocUrl: "sample_doc2.pdf", articleType: "研究原著", publishYear: "2023", volume: "54", issue: "10", impactFactor: "1.892", doi: "10.7501/j.issn.0253-2670.2023.10.00x", abstractText: "目的：研究白芍的化学成分及其主要成分的抗炎活性...", citationsText: "He X, Bai Y. Paeoniflorin: a review of its pharmacology. Fitoterapia. 2011" },
            { id: "lit003", title: "炎症性肠病治疗靶点研究新进展.pdf", authors: "赵敏, 孙悦", keywords: ["IBD", "JAK抑制剂", "生物制剂"], source: "Elsevier - Journal of Crohn's and Colitis", uploadDate: "2024-02-20", tags: ["IBD", "药靶"], status: "unprocessed", originalDocUrl: "sample_doc3.pdf", articleType: "研究论文", publishYear: "2024", volume: "18", issue: "2", impactFactor: "9.071", doi: "10.1093/ecco-jcc/jjad180", abstractText: "Janus激酶（JAK）抑制剂作为一种新型口服小分子药物...", citationsText: "Torres J, et al. Lancet. 2017" },
            { id: "lit004", title: "北豆根主要生物碱的药理作用探讨.pdf", authors: "周强", keywords: ["北豆根", "生物碱", "镇咳", "祛痰"], source: "Springer - Phytomedicine", uploadDate: "2024-01-15", tags: ["药材", "北豆根", "药理"], status: "analyzed", originalDocUrl: "sample_doc4.pdf", articleType: "实验研究", publishYear: "2023", volume: "110", issue: "", impactFactor: "6.656", doi: "10.1016/j.phymed.2022.154501", abstractText: "北豆根为防己科植物蝙蝠葛的干燥根茎...", citationsText: "《中华人民共和国药典》2020年版" },
            { id: "lit005", title: "巴豆在现代临床中的应用及其安全性评估.pdf", authors: "吴刚, 陈晨", keywords: ["巴豆", "泻下", "毒性", "临床应用"], source: "医药导报", uploadDate: "2023-12-01", tags: ["药材", "巴豆", "临床研究"], status: "error", originalDocUrl: "sample_doc5.pdf", articleType: "临床报告", publishYear: "2022", volume: "41", issue: "S1", impactFactor: "0.985", doi: "10.3802/j.issn.1004-0781.2022.S1.xx", abstractText: "巴豆作为一种传统中药，具有峻下冷积、逐水退肿的功效...", citationsText: "国家药典委员会. 中华人民共和国药典临床用药须知:中药饮片卷. 2020." },
        ];

        const literatureTableBody = document.getElementById('literature-table-body');
        const litPaginationControls = document.getElementById('lit-pagination-controls');
        const tagFilterLitSelect = document.getElementById('tag-filter-lit');
        const batchAnalysisBtn = document.getElementById('batch-analysis-btn');
        const comprehensiveAnalysisBtn = document.getElementById('comprehensive-analysis-btn');
        const selectAllCheckbox = document.getElementById('select-all-literature');

        const itemsPerPageLit = 10;
        let currentPageLit = 1;
        let currentLitSearchTerm = '';
        let currentLitTagFilter = '';
        let currentLitStatusFilter = '';

        function getLitStatusBadge(status) {
            switch (status) {
                case 'unprocessed': return '<span class="status-badge status-unprocessed">未处理</span>';
                case 'processing': return '<span class="status-badge status-processing">处理中</span>';
                case 'analyzed': return '<span class="status-badge status-analyzed">已分析</span>';
                case 'error': return '<span class="status-badge status-error">错误</span>';
                default: return `<span class="status-badge">${status}</span>`;
            }
        }
        function openLiteratureResearch(literatureId, literatureTitle) {
             if (window.parent && window.parent.openTab) {
                window.parent.openTab(`文献调研: ${literatureTitle.substring(0,15)}...`, `literature_research.html?id=${encodeURIComponent(literatureId)}`);
            } else {
                window.location.href = `literature_research.html?id=${encodeURIComponent(literatureId)}`;
            }
        }
        function openLiteratureInfoDetail(literatureId, literatureTitle) {
             if (window.parent && window.parent.openTab) {
                window.parent.openTab(`文献信息: ${literatureTitle.substring(0,15)}...`, `literature_info_detail.html?id=${encodeURIComponent(literatureId)}`);
            } else {
                window.location.href = `literature_info_detail.html?id=${encodeURIComponent(literatureId)}`;
            }
        }

        function renderLitTable() {
            console.log('开始渲染表格');
            console.log('Mock数据:', mockLiteratureData);
            console.log('当前搜索词:', currentLitSearchTerm);
            console.log('当前标签过滤:', currentLitTagFilter);
            console.log('当前状态过滤:', currentLitStatusFilter);
            
            literatureTableBody.innerHTML = '';
            const filteredData = mockLiteratureData.filter(item => {
                const matchesSearch = currentLitSearchTerm === '' || 
                                    item.title.toLowerCase().includes(currentLitSearchTerm.toLowerCase()) ||
                                    item.authors.toLowerCase().includes(currentLitSearchTerm.toLowerCase()) ||
                                    item.keywords.some(k => k.toLowerCase().includes(currentLitSearchTerm.toLowerCase()));
                const matchesTag = currentLitTagFilter === '' || item.tags.includes(currentLitTagFilter);
                const matchesStatus = currentLitStatusFilter === '' || item.status === currentLitStatusFilter;
                return matchesSearch && matchesTag && matchesStatus;
            });

            const paginatedData = filteredData.slice((currentPageLit - 1) * itemsPerPageLit, currentPageLit * itemsPerPageLit);

            if (paginatedData.length === 0) {
                literatureTableBody.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-slate-500">没有符合条件的文献记录。</td></tr>`;
                renderLitPagination(0);
                return;
            }

            paginatedData.forEach(item => {
                const escapedTitle = item.title.replace(/\'/g, "\\\\'").replace(/\\"/g, '\\\\\\"');
                const row = `
                    <tr class="bg-white border-b hover:bg-slate-50">
                        <td class="p-3"><input type="checkbox" data-id="${item.id}" class="literature-item-checkbox form-checkbox h-4 w-4 text-blue-600 border-slate-300 rounded accent-blue-600"></td>
                        <td class="p-3 font-medium text-slate-900 hover:text-blue-600 cursor-pointer truncate" title="${item.title}" onclick="openLiteratureResearch(\'${item.id}\', \'${escapedTitle}\')">${item.title}</td>
                        <td class="p-3 text-slate-600 truncate" title="${item.authors}">${item.authors}</td>
                        <td class="p-3 text-slate-600 truncate-2-lines" title="${item.keywords.join(', ')}">${item.keywords.join(', ')}</td>
                        <td class="p-3 text-slate-600 truncate" title="${item.source}">${item.source}</td>
                        <td class="p-3 text-slate-600">${item.uploadDate}</td>
                        <td class="p-3 text-slate-600 truncate" title="${item.tags.join(', ')}">${item.tags.join(', ')}</td>
                        <td class="p-3">${getLitStatusBadge(item.status)}</td>
                        <td class="p-3 text-center relative">
                            <button class="text-blue-600 hover:text-blue-800 lit-action-toggle"><i class="fas fa-ellipsis-v"></i></button>
                            <div class="action-menu hidden bg-white border border-slate-200 rounded-md shadow-lg py-1 w-32">
                                <a href="#" onclick="openLiteratureResearch('${item.id}', '${escapedTitle}')" class="block px-3 py-1.5 text-xs text-slate-700 hover:bg-slate-100">开始调研</a>
                                <a href="#" onclick="openLiteratureInfoDetail('${item.id}', '${escapedTitle}')" class="block px-3 py-1.5 text-xs text-slate-700 hover:bg-slate-100">查看详情</a>
                                <a href="#" onclick="alert('下载 ${escapedTitle} (占位)')" class="block px-3 py-1.5 text-xs text-slate-700 hover:bg-slate-100">下载原文</a>
                                <div class="my-1 border-t border-slate-100"></div>
                                <a href="#" onclick="alert('删除 ${escapedTitle} (占位)')" class="block px-3 py-1.5 text-xs text-red-600 hover:bg-red-50">删除文献</a>
                            </div>
                        </td>
                    </tr>
                `;
                literatureTableBody.innerHTML += row;
            });
            renderLitPagination(filteredData.length);
            attachLitActionMenuListeners();
            updateBatchButtonsState();
        }

        function renderLitPagination(totalItems) {
            litPaginationControls.innerHTML = '';
            const totalPages = Math.ceil(totalItems / itemsPerPageLit);
            if (totalPages <= 1) return;

            litPaginationControls.innerHTML += `<button data-page="${currentPageLit - 1}" class="px-3 py-1 text-sm rounded-md ${currentPageLit === 1 ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-600'}" ${currentPageLit === 1 ? 'disabled' : ''}>< Previous</button>`;
            for (let i = 1; i <= totalPages; i++) {
                litPaginationControls.innerHTML += `<button data-page="${i}" class="px-3 py-1 text-sm rounded-md ${i === currentPageLit ? 'bg-blue-500 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-600'}">${i}</button>`;
            }
            litPaginationControls.innerHTML += `<button data-page="${currentPageLit + 1}" class="px-3 py-1 text-sm rounded-md ${currentPageLit === totalPages ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-600'}" ${currentPageLit === totalPages ? 'disabled' : ''}>Next ></button>`;
            
            document.querySelectorAll('#lit-pagination-controls button[data-page]').forEach(button => {
                button.addEventListener('click', (e) => {
                    currentPageLit = parseInt(e.currentTarget.dataset.page);
                    renderLitTable();
                });
            });
        }
        
        function attachLitActionMenuListeners() {
            document.querySelectorAll('.lit-action-toggle').forEach(toggle => {
                // Simple re-attachment by removing old and adding new
                const newToggle = toggle.cloneNode(true);
                toggle.parentNode.replaceChild(newToggle, toggle);
                newToggle.addEventListener('click', function(event) {
                    event.stopPropagation();
                    document.querySelectorAll('.action-menu').forEach(m => {
                        if (m !== this.nextElementSibling) m.classList.add('hidden');
                    });
                    this.nextElementSibling.classList.toggle('hidden');
                });
            });
        }
        
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.lit-action-toggle') && !event.target.closest('.action-menu')) {
                document.querySelectorAll('.action-menu').forEach(menu => menu.classList.add('hidden'));
            }
        });

        document.getElementById('search-literature').addEventListener('input', (e) => {
            currentLitSearchTerm = e.target.value;
            currentPageLit = 1;
            renderLitTable();
        });
        document.getElementById('status-filter-lit').addEventListener('change', (e) => {
            currentLitStatusFilter = e.target.value;
            currentPageLit = 1;
            renderLitTable();
        });

        tagFilterLitSelect.addEventListener('change', (e) => {
            currentLitTagFilter = e.target.value;
            currentPageLit = 1;
            renderLitTable();
            showHideAnalysisButtons();
        });

        function showHideAnalysisButtons() {
            if (currentLitTagFilter && currentLitTagFilter !== "") {
                // 显示按钮
                [batchAnalysisBtn, comprehensiveAnalysisBtn].forEach(btn => {
                    btn.classList.remove('hidden');
                    setTimeout(() => {
                        btn.classList.remove('opacity-0', 'scale-95');
                        btn.classList.add('opacity-100', 'scale-100');
                    }, 50);
                });
            } else {
                // 隐藏按钮
                [batchAnalysisBtn, comprehensiveAnalysisBtn].forEach(btn => {
                    btn.classList.add('opacity-0', 'scale-95');
                    setTimeout(() => {
                        btn.classList.add('hidden');
                    }, 300);
                });
            }
        }

        function updateBatchButtonsState() {
            const selectedIds = getSelectedLiteratureIds();
            if (selectedIds.length > 0) {
                batchAnalysisBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                batchAnalysisBtn.disabled = false;
            } else {
                batchAnalysisBtn.classList.add('opacity-50', 'cursor-not-allowed');
                batchAnalysisBtn.disabled = true;
            }
        }

        function getSelectedLiteratureIds() {
            const selectedIds = [];
            document.querySelectorAll('.literature-item-checkbox:checked').forEach(checkbox => {
                selectedIds.push(checkbox.dataset.id);
            });
            return selectedIds;
        }

        selectAllCheckbox.addEventListener('change', function() {
            document.querySelectorAll('.literature-item-checkbox').forEach(checkbox => {
                checkbox.checked = this.checked;
            });
            updateBatchButtonsState();
        });

        batchAnalysisBtn.addEventListener('click', () => {
            const selectedIds = getSelectedLiteratureIds();
            if (selectedIds.length > 0) {
                const url = `batch_research.html?source=literature_management&selected_ids=${selectedIds.join(',')}`;
                if (window.parent && window.parent.openTab) {
                    window.parent.openTab(`批量调研 (${selectedIds.length}项)`, url);
                } else {
                    window.location.href = url;
                }
            } else {
                alert('请至少选择一篇文献进行批量调研。');
            }
        });
        
        comprehensiveAnalysisBtn.addEventListener('click', () => {
            const selectedIds = getSelectedLiteratureIds();
            if (selectedIds.length > 0) {
                alert(`启动对 ${selectedIds.length} 篇文献的综合调研 (占位符)。ID: ${selectedIds.join(',')}`);
            } else {
                alert('请至少选择一篇文献进行综合调研。');
            }
        });

        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            console.log('页面加载完成，开始初始化表格');
            renderLitTable();
            showHideAnalysisButtons();
        });

        // 模拟数据
        let mockFolders = [
            { id: 'folder1', name: '白芍' },
            { id: 'folder2', name: '当归' },
            { id: 'folder3', name: 'IBD' },
            { id: 'folder4', name: '免疫' }
        ];

        let mockTags = [
            { id: 'tag1', name: '指纹图谱', desc: '包含指纹图谱相关内容' },
            { id: 'tag2', name: '含量测定', desc: '包含含量测定相关内容' },
            { id: 'tag3', name: '临床研究', desc: '临床研究相关文献' },
            { id: 'tag4', name: '综述', desc: '综述类文献' }
        ];

        // 当前选中的标签
        let selectedTags = new Set();

        // DOM 元素
        const uploadDialog = document.getElementById('upload-dialog');
        const uploadBtn = document.getElementById('upload-literature-btn');
        const tagInput = document.getElementById('tag-input');
        const tagSuggestions = document.getElementById('tag-suggestions');
        const selectedTagsContainer = document.getElementById('selected-tags');
        const folderInput = document.getElementById('folder-input');
        const folderSuggestions = document.getElementById('folder-suggestions');
        const addTagDialog = document.getElementById('add-tag-dialog');
        const fileUpload = document.getElementById('file-upload');

        // 显示上传对话框
        uploadBtn.addEventListener('click', () => {
            uploadDialog.classList.add('active');
            // 重置表单
            fileUpload.value = '';
            folderInput.value = '';
            folderInput.dataset.selectedId = '';
            selectedTags.clear();
            renderSelectedTags();
        });

        // 关闭上传对话框
        function closeDialog() {
            uploadDialog.classList.remove('active');
        }

        // 文件夹搜索和选择
        folderInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredFolders = mockFolders.filter(folder => 
                folder.name.toLowerCase().includes(searchTerm)
            );
            
            if (filteredFolders.length > 0 && searchTerm) {
                folderSuggestions.innerHTML = filteredFolders
                    .map(folder => `
                        <div class="p-2 hover:bg-slate-100 cursor-pointer" 
                             onclick="selectFolder('${folder.id}', '${folder.name}')">
                            ${folder.name}
                        </div>
                    `).join('');
                folderSuggestions.classList.remove('hidden');
            } else {
                folderSuggestions.classList.add('hidden');
            }
        });

        // 标签搜索和选择
        tagInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredTags = mockTags.filter(tag => 
                tag.name.toLowerCase().includes(searchTerm) && 
                !selectedTags.has(tag.id)
            );
            
            if (filteredTags.length > 0 && searchTerm) {
                tagSuggestions.innerHTML = filteredTags
                    .map(tag => `
                        <div class="p-2 hover:bg-slate-100 cursor-pointer" 
                             onclick="selectTag('${tag.id}', '${tag.name}')">
                            <div class="font-medium">${tag.name}</div>
                            ${tag.desc ? `<div class="text-xs text-slate-500">${tag.desc}</div>` : ''}
                        </div>
                    `).join('');
                tagSuggestions.classList.remove('hidden');
            } else {
                tagSuggestions.classList.add('hidden');
            }
        });

        // 选择文件夹
        function selectFolder(folderId, folderName) {
            folderInput.value = folderName;
            folderInput.dataset.selectedId = folderId;
            folderSuggestions.classList.add('hidden');
        }

        // 选择标签
        function selectTag(tagId, tagName) {
            if (!selectedTags.has(tagId)) {
                selectedTags.add(tagId);
                const tagElement = document.createElement('div');
                tagElement.className = 'selected-tag';
                tagElement.innerHTML = `
                    ${tagName}
                    <button class="ml-1 text-blue-700 hover:text-blue-800" onclick="removeTag('${tagId}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                selectedTagsContainer.appendChild(tagElement);
                tagInput.value = '';
                tagSuggestions.classList.add('hidden');
            }
        }

        // 移除标签
        function removeTag(tagId) {
            selectedTags.delete(tagId);
            renderSelectedTags();
        }

        // 渲染已选标签
        function renderSelectedTags() {
            selectedTagsContainer.innerHTML = '';
            for (const tagId of selectedTags) {
                const tag = mockTags.find(t => t.id === tagId);
                if (tag) {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'selected-tag';
                    tagElement.innerHTML = `
                        ${tag.name}
                        <button class="ml-1 text-blue-700 hover:text-blue-800" onclick="removeTag('${tag.id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    selectedTagsContainer.appendChild(tagElement);
                }
            }
        }

        // 显示添加标签对话框
        function showAddTagDialog() {
            addTagDialog.classList.add('active');
        }

        // 关闭添加标签对话框
        function closeAddTagDialog() {
            addTagDialog.classList.remove('active');
            document.getElementById('new-tag-name').value = '';
            document.getElementById('new-tag-desc').value = '';
        }

        // 提交新标签
        function submitNewTag() {
            const tagName = document.getElementById('new-tag-name').value.trim();
            const tagDesc = document.getElementById('new-tag-desc').value.trim();
            
            if (!tagName) {
                alert('请输入标签名！');
                return;
            }

            // 检查标签名是否已存在
            if (mockTags.some(tag => tag.name === tagName)) {
                alert('该标签名已存在！');
                return;
            }

            // 创建新标签
            const newTag = {
                id: 'tag' + (mockTags.length + 1),
                name: tagName,
                desc: tagDesc
            };
            mockTags.push(newTag);

            // 自动选中新创建的标签
            selectTag(newTag.id, newTag.name);
            closeAddTagDialog();
        }

        // 提交上传
        function submitUpload() {
            const file = fileUpload.files[0];
            const folderId = folderInput.dataset.selectedId;
            const folderName = folderInput.value;
            const selectedTagIds = Array.from(selectedTags);

            if (!file) {
                alert('请选择要上传的文件！');
                return;
            }

            if (!folderId) {
                alert('请选择所属文件夹！');
                return;
            }

            if (selectedTagIds.length === 0) {
                alert('请至少选择一个标签！');
                return;
            }

            // 在实际应用中，这里应该调用上传 API
            console.log('上传文件:', {
                file: file.name,
                folderId,
                folderName,
                selectedTagIds
            });
            alert('文件上传成功！');
            closeDialog();
        }

        // 点击外部关闭建议列表和对话框
        document.addEventListener('click', (e) => {
            if (!tagInput.contains(e.target) && !tagSuggestions.contains(e.target)) {
                tagSuggestions.classList.add('hidden');
            }
            if (!folderInput.contains(e.target) && !folderSuggestions.contains(e.target)) {
                folderSuggestions.classList.add('hidden');
            }
        });

        // 文件拖放上传
        const dropZone = document.querySelector('.border-dashed');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500');
        });

        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileUpload.files = files;
            }
        });
    </script>
</body>
</html>