<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>结果详情 - 信息溯源 (编号)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        .status-badge-lg { padding: 0.3rem 0.8rem; font-size: 0.8rem; border-radius: 0.375rem; font-weight: 500; }
        .status-pending { background-color: #fef3c7; color: #b45309; }
        .status-approved { background-color: #d1fae5; color: #047857; }
        .status-rejected { background-color: #fee2e2; color: #b91c1c; }
        .version-item.active { background-color: #e0f2fe; border-left-color: #0ea5e9; }
        .result-content-display { white-space: pre-wrap; word-wrap: break-word; line-height: 1.8; } 
        #original-doc-iframe { min-height: calc(100vh - 150px); }
        .pane-transition { transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }

        .source-ref { /* ... (same as before) ... */
            font-size: 0.7em; font-weight: 600; padding: 0.5px 2.5px; border-radius: 3px;
            background-color: #e0e7ff; color: #3730a3; cursor: pointer;
            margin-left: 2px; vertical-align: super; line-height: 1; position: relative; 
            transition: background-color 0.2s, color 0.2s;
        }
        .source-ref:hover, .source-ref:focus-visible { background-color: #3730a3; color: white; outline: none; }
        
        .ref-tooltip {
            visibility: hidden; width: 320px; background-color: #1f2937; 
            color: #f9fafb; text-align: left; border-radius: 6px;
            padding: 10px 12px; position: absolute; z-index: 999; /* Increased z-index */
            bottom: 160%; left: 50%; transform: translateX(-50%);
            opacity: 0; transition: opacity 0.2s, visibility 0.2s;
            font-size: 0.78rem; line-height: 1.5; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            pointer-events: none; 
        }
        .source-ref:hover .ref-tooltip, .source-ref:focus-visible .ref-tooltip { visibility: visible; opacity: 1; pointer-events: auto; }
        .ref-tooltip::after { /* ... (same as before) ... */
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid; border-color: #1f2937 transparent transparent transparent;
        }
        .ref-tooltip strong { color: #9ca3af; display: block; margin-bottom: 3px;}
        .ref-tooltip a { color: #60a5fa; text-decoration: underline; }
        .ref-tooltip a:hover { color: #93c5fd; }
        .ref-tooltip .source-text-snippet { /* ... (same as before) ... */
            display: block; background-color: #4a5568; padding: 5px; border-radius: 3px; margin-top: 4px;
            max-height: 60px; overflow-y: auto; font-style: italic; font-size: 0.75rem;
        }

        .collapsible-panel { transition: max-height 0.35s cubic-bezier(0.25, 0.1, 0.25, 1); overflow: hidden; }
        .collapsible-panel.collapsed { max-height: 0px !important; padding-top: 0 !important; padding-bottom: 0 !important; border-top-width: 0 !important; margin-bottom: 0 !important; }
        
        #source-list-panel { max-height: 250px; /* Increased default visible height */ }
        #version-history-panel { max-height: 200px; /* Default visible height for version history */ }

        .source-list-item { /* ... (same as before) ... */ }
        .source-list-item .ref-number { /* ... (same as before) ... */ }

        .pdf-highlight-overlay { /* ... (same as before) ... */ }
        .pdf-page-indicator { /* ... (same as before) ... */ }
    </style>
</head>
<body class="bg-slate-100 font-sans">
    <div class="flex flex-col h-screen">
        <header class="bg-white shadow-sm p-3 border-b border-slate-200 flex-shrink-0">
             <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center min-w-0">
                    <h1 id="result-main-title" class="text-lg font-semibold text-slate-800 truncate mr-4" title="结果详情: 加载中...">结果详情: 加载中...</h1>
                </div>
                <div class="flex items-center space-x-2" id="header-actions-buttons">
                    <button id="copy-result-btn" title="复制结果内容" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md flex items-center">
                        <i class="fas fa-copy mr-1.5"></i> 复制
                    </button>
                    <button id="export-result-btn" title="导出结果" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md flex items-center">
                        <i class="fas fa-file-export mr-1.5"></i> 导出
                    </button>
                    <button id="review-result-btn" title="审核结果" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md flex items-center">
                        <i class="fas fa-check-double mr-1.5"></i> 审核
                    </button>
                    <button id="toggle-original-doc-btn" title="切换原始文献显隐" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md flex items-center">
                        <i class="fas fa-eye-slash mr-1.5"></i> <span id="toggle-doc-text">隐藏原文</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 flex flex-col md:flex-row overflow-hidden p-3 gap-3">
            <div id="left-pane" class="w-full md:w-1/2 flex flex-col bg-white rounded-lg shadow overflow-hidden pane-transition">
                <div class="p-4 border-b border-slate-200 flex-shrink-0">
                    <div class="flex justify-between items-center mb-1">
                        <h2 class="text-base font-semibold text-slate-700">结果内容 
                            <span class="text-xs text-slate-400 font-normal">(点击<sup class="source-ref !bg-transparent !text-blue-500 !p-0 !font-bold">#</sup>查看来源)</span>
                        </h2>
                        <span id="result-status-badge" class="status-badge-lg">加载中</span>
                    </div>
                    <p id="result-version-info" class="text-xs text-slate-500">版本: - | 更新: -</p>
                </div>

                <div id="result-content-area" class="p-4 flex-grow overflow-y-auto custom-scrollbar">
                    <div id="result-text-display" class="text-sm text-slate-700 result-content-display">加载中...</div>
                    <textarea id="result-text-edit" class="hidden w-full h-full text-sm border border-slate-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 custom-scrollbar" rows="10" placeholder="在此编辑结果内容。使用 [[文本内容|refs:sourceId1,sourceId2]] 格式添加溯源。\n源定义在版本数据中，例如：s1, s2..."></textarea>
                </div>
                
                <div id="edit-specific-actions" class="p-3 border-t border-slate-200 bg-slate-50 hidden flex-shrink-0">
                     <div class="mb-2">
                         <label for="revision-notes" class="block text-xs font-medium text-slate-600 mb-1">修改说明 (可选)</label>
                         <input type="text" id="revision-notes" class="w-full text-xs p-1.5 border border-slate-300 rounded-md focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button id="cancel-edit-btn" class="px-3 py-1.5 text-xs font-medium text-slate-700 bg-slate-200 hover:bg-slate-300 rounded-md">取消</button>
                        <button id="save-changes-btn" class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">保存修改</button>
                        <button id="approve-result-btn" class="px-3 py-1.5 text-xs font-medium text-white bg-green-600 hover:bg-green-700 rounded-md">审核通过</button>
                    </div>
                </div>
                
                <div id="source-list-panel-wrapper" class="flex-shrink-0 border-t border-slate-200">
                    <button id="toggle-source-list-btn" class="w-full text-left p-2 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 focus:outline-none flex justify-between items-center">
                        <span>参考文献/来源列表</span>
                        <i id="source-list-caret" class="fas fa-chevron-up transition-transform"></i> 
                    </button>
                    <div id="source-list-panel" class="collapsible-panel p-3 bg-slate-50 overflow-y-auto custom-scrollbar collapsed">
                        <ul id="source-list-ul" class="text-xs space-y-1.5">
                            <li class="text-slate-400 italic">暂无来源信息或未加载。</li>
                        </ul>
                    </div>
                </div>

                <div id="version-history-wrapper" class="flex-shrink-0 border-t border-slate-200">
                    <button id="toggle-version-history-btn" class="w-full text-left p-2 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 focus:outline-none flex justify-between items-center">
                        <span>修改历史</span>
                        <i id="version-history-caret" class="fas fa-chevron-up transition-transform"></i> 
                    </button>
                    <div id="version-history-panel" class="collapsible-panel p-3 bg-slate-50/50 overflow-y-auto custom-scrollbar collapsed">
                        <ul id="version-history-list" class="space-y-1.5 text-xs">
                            <li class="text-slate-500">加载中...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="right-pane" class="w-full md:w-1/2 bg-white rounded-lg shadow overflow-hidden flex flex-col pane-transition relative">
                <div class="p-3 border-b border-slate-200 bg-slate-50 flex justify-between items-center flex-shrink-0">
                    <h2 class="text-base font-semibold text-slate-700">原始文献</h2>
                </div>
                <div class="p-1 flex-grow custom-scrollbar overflow-auto relative bg-slate-200">
                    <iframe id="original-doc-iframe" src="" class="w-full h-full border-none" title="Original Document"></iframe>
                    <div id="pdf-highlight-overlay" class="pdf-highlight-overlay hidden"></div>
                    <div id="pdf-page-indicator" class="pdf-page-indicator">Page ?</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Mock Data ---
        const mockResultDetailsStore = {
            "res001": { 
                name: "白芍文献1的有效成分及药理作用分析结果", 
                status: "approved", 
                originalDocUrl: "https://www.africau.edu/images/default/sample.pdf", 
                currentVersion: "v1.3",
                versions: [
                    { 
                        version: "v1.3", 
                        date: "2025-02-20", 
                        editor: "张三", 
                        notes: "更新为编号引用格式", 
                        content: "文献明确指出[[白芍总苷具有显著的抗炎、镇痛双重药理作用|refs:s1]]。其主要活性成分包括[[芍药苷|refs:s1]]和羟基芍药苷等。这些发现与[[一项重要的外部研究|refs:s2]]的结果相符。因此，综合来看，[[白芍作为传统中药，其药用价值得到了现代药理学的支持|refs:s3]]。这句话同时参考了[[文献和外部链接|refs:s1,s2]]。",
                        sources: {
                            "s1": { type: "doc", page: 2, rect: "50,100,300,40", sel: "段落开头'白芍总苷...'", displayText: "本文献，第 2 页，高亮区域", docSnippet: "白芍总苷具有显著的抗炎、镇痛双重药理作用，对多种炎症模型均显示出良好的抑制效果..." },
                            "s2": { type: "url", link: "https://pubmed.ncbi.nlm.nih.gov/12345678/", displayText: "外部研究: PubMed ID 12345678" },
                        }, 
                        approved: true,
                        reviewComment: "内容准确，引用规范",
                        reviewDate: "2025-02-21",
                        reviewer: "李四"
                    }
                ]
            },
            "res003": {
                name: "综述：IBD治疗中草药应用前景分析",
                status: "rejected",
                originalDocUrl: "https://www.africau.edu/images/default/sample.pdf",
                currentVersion: "v1.0",
                versions: [
                    {
                        version: "v1.0",
                        date: "2025-01-20",
                        editor: "孙八",
                        notes: "初版提交",
                        content: "研究表明[[多种中草药在IBD治疗中显示出较好的效果|refs:s1]]。特别是[[黄芩素对肠道炎症的抑制作用显著|refs:s2]]。然而，[[临床应用仍存在剂量标准化等问题|refs:s3]]。",
                        sources: {
                            "s1": { type: "doc", page: 1, rect: "100,150,300,30", displayText: "文献第1页", docSnippet: "多项研究表明，草药如黄芩、白术等在IBD的治疗中显示出较好的临床效果..." },
                            "s2": { type: "url", link: "https://example.com/research/ibd", displayText: "外部研究：黄芩素功效分析" },
                            "s3": { type: "doc", page: 3, displayText: "文献第3页结论部分" }
                        },
                        approved: false,
                        reviewComment: "内容有误，参考文献不足，需要补充更多临床研究证据",
                        reviewDate: "2025-01-25",
                        reviewer: "钱七"
                    }
                ]
            }
        };
        
        // --- DOM Elements ---
        let currentResultId = null;
        let currentResultData = null;
        let displayedVersion = null;
        let isEditMode = false;
        let isOriginalDocVisible = true;

        // DOM元素引用
        const elements = {
            resultMainTitle: document.getElementById('result-main-title'),
            resultStatusBadge: document.getElementById('result-status-badge'),
            resultVersionInfo: document.getElementById('result-version-info'),
            resultTextDisplay: document.getElementById('result-text-display'),
            resultTextEdit: document.getElementById('result-text-edit'),
            editSpecificActions: document.getElementById('edit-specific-actions'),
            revisionNotesInput: document.getElementById('revision-notes'),
            headerActionsButtons: document.getElementById('header-actions-buttons'),
            versionHistoryList: document.getElementById('version-history-list'),
            originalDocIframe: document.getElementById('original-doc-iframe'),
            leftPane: document.getElementById('left-pane'),
            rightPane: document.getElementById('right-pane'),
            toggleOriginalDocBtn: document.getElementById('toggle-original-doc-btn'),
            toggleDocText: document.getElementById('toggle-doc-text'),
            sourceListUL: document.getElementById('source-list-ul'),
            copyResultBtn: document.getElementById('copy-result-btn'),
            exportResultBtn: document.getElementById('export-result-btn'),
            reviewResultBtn: document.getElementById('review-result-btn'),
            saveChangesBtn: document.getElementById('save-changes-btn'),
            approveResultBtn: document.getElementById('approve-result-btn'),
            cancelEditBtn: document.getElementById('cancel-edit-btn')
        };

        // --- 功能函数 ---
        
        // 复制功能
        function copyResultContent() {
            const content = displayedVersion.content;
            navigator.clipboard.writeText(content).then(() => {
                showToast('结果内容已复制到剪贴板');
            }).catch(err => {
                console.error('复制失败:', err);
                showToast('复制失败，请重试', 'error');
            });
        }

        // 导出功能
        function exportResult() {
            const exportData = {
                name: currentResultData.name,
                version: displayedVersion.version,
                content: displayedVersion.content,
                sources: displayedVersion.sources,
                exportDate: new Date().toISOString(),
                status: currentResultData.status
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `result_${currentResultId}_${displayedVersion.version}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('结果已导出');
        }

        // 进入编辑模式
        function enterEditMode() {
            isEditMode = true;
            elements.resultTextDisplay.classList.add('hidden');
            elements.resultTextEdit.classList.remove('hidden');
            elements.editSpecificActions.classList.remove('hidden');
            elements.resultTextEdit.value = displayedVersion.content;
            elements.reviewResultBtn.disabled = true;
            showToast('已进入编辑模式');
        }

        // 退出编辑模式
        function exitEditMode() {
            isEditMode = false;
            elements.resultTextDisplay.classList.remove('hidden');
            elements.resultTextEdit.classList.add('hidden');
            elements.editSpecificActions.classList.add('hidden');
            elements.reviewResultBtn.disabled = false;
            displayVersionContent(displayedVersion);
        }

        // 保存修改
        function saveChanges() {
            const newContent = elements.resultTextEdit.value;
            const revisionNotes = elements.revisionNotesInput.value;
            
            // 创建新版本
            const newVersion = {
                version: `v${parseFloat(displayedVersion.version.substring(1)) + 0.1}`,
                date: new Date().toISOString().split('T')[0],
                editor: "当前用户", // 实际应用中应该从用户会话获取
                notes: revisionNotes,
                content: newContent,
                sources: displayedVersion.sources, // 保持原有的sources
                approved: false
            };

            // 更新数据
            currentResultData.versions.unshift(newVersion);
            currentResultData.currentVersion = newVersion.version;
            displayedVersion = newVersion;

            // 更新UI
            exitEditMode();
            updateVersionHistoryList();
            showToast('修改已保存');
        }

        // 审核功能
        function reviewResult(isApproved) {
            const reviewDialog = document.createElement('div');
            reviewDialog.innerHTML = `
                <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4">
                        <h3 class="text-lg font-semibold mb-4">审核确认</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">审核说明</label>
                            <textarea id="review-comment" class="w-full border rounded-md p-2" rows="3"></textarea>
                        </div>
                        <div class="flex justify-end space-x-2">
                            <button class="px-4 py-2 text-sm text-gray-600 hover:bg-gray-100 rounded-md" onclick="this.closest('.fixed').remove()">取消</button>
                            <button class="px-4 py-2 text-sm text-white ${isApproved ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} rounded-md" onclick="submitReview(${isApproved}, this)">确认</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(reviewDialog);
        }

        // 提交审核结果
        function submitReview(isApproved, buttonElement) {
            const dialog = buttonElement.closest('.fixed');
            const comment = dialog.querySelector('#review-comment').value;
            
            displayedVersion.approved = isApproved;
            displayedVersion.reviewComment = comment;
            displayedVersion.reviewDate = new Date().toISOString().split('T')[0];
            displayedVersion.reviewer = "当前用户"; // 实际应用中应该从用户会话获取
            
            currentResultData.status = isApproved ? 'approved' : 'rejected';
            
            // 更新UI
            updateUI();
            dialog.remove();
            showToast(`审核${isApproved ? '通过' : '不通过'}已提交`);
        }

        // 显示提示消息
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white ${
                type === 'success' ? 'bg-green-600' : 'bg-red-600'
            } transition-opacity duration-300`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 更新版本历史列表
        function updateVersionHistoryList() {
            const versions = currentResultData.versions;
            elements.versionHistoryList.innerHTML = versions.map((ver, index) => `
                <li class="version-item ${ver.version === displayedVersion.version ? 'active' : ''} p-2 border-l-4 hover:bg-blue-50 cursor-pointer"
                    onclick="switchToVersion('${ver.version}')">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-medium">${ver.version}</span>
                            <span class="text-slate-500 ml-2">${ver.date}</span>
                        </div>
                        ${ver.approved !== undefined ? `
                            <span class="text-xs ${ver.approved ? 'text-green-600' : 'text-red-600'}">
                                ${ver.approved ? '已通过' : '未通过'}
                            </span>
                        ` : ''}
                    </div>
                    <div class="text-slate-600 mt-1">${ver.notes || '无说明'}</div>
                    ${ver.reviewComment ? `
                        <div class="text-slate-500 mt-1 text-xs">
                            审核意见: ${ver.reviewComment}
                        </div>
                    ` : ''}
                </li>
            `).join('');
        }

        // 切换版本
        function switchToVersion(versionId) {
            const version = currentResultData.versions.find(v => v.version === versionId);
            if (version) {
                displayedVersion = version;
                displayVersionContent(version);
                updateVersionHistoryList();
            }
        }

        // 更新UI
        function updateUI() {
            elements.resultMainTitle.textContent = `结果详情: ${currentResultData.name}`;
            elements.resultStatusBadge.innerHTML = getStatusBadgeHTML(currentResultData.status);
            elements.originalDocIframe.src = currentResultData.originalDocUrl;
            updateVersionHistoryList();
        }

        // 状态徽章生成函数
        function getStatusBadgeHTML(status) {
            const statusMap = {
                'pending': { class: 'status-pending', text: '待审核' },
                'approved': { class: 'status-approved', text: '审核通过' },
                'rejected': { class: 'status-rejected', text: '审核不通过' }
            };
            const statusInfo = statusMap[status] || { class: 'bg-slate-200 text-slate-700', text: status };
            return `<span class="status-badge-lg ${statusInfo.class}">${statusInfo.text}</span>`;
        }

        // HTML转义函数
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // 解析带引用的内容
        function parseSourcedContentWithRefs(rawContent, sources = {}) {
            const regex = /\[\[(.*?)\|refs:([a-zA-Z0-9_,-]+)\]\]/g;
            let resultHTML = "";
            let lastIndex = 0;
            const sourceIdToNumberMap = {};
            let currentRefNumber = 1;

            // 首先映射所有引用编号
            for (const match of rawContent.matchAll(regex)) {
                const refIds = match[2].trim().split(',');
                refIds.forEach(refId => {
                    const cleanedRefId = refId.trim();
                    if (sources[cleanedRefId] && !sourceIdToNumberMap[cleanedRefId]) {
                        sourceIdToNumberMap[cleanedRefId] = currentRefNumber++;
                    }
                });
            }

            // 然后处理文本和引用
            for (const match of rawContent.matchAll(regex)) {
                const textBefore = rawContent.substring(lastIndex, match.index);
                const inferredText = match[1].trim();
                const refIds = match[2].trim().split(',');
                
                resultHTML += escapeHtml(textBefore);
                resultHTML += `<span class="inferred-text">${escapeHtml(inferredText)}</span>`;

                refIds.forEach((refId, idx) => {
                    const cleanedRefId = refId.trim();
                    const refNum = sourceIdToNumberMap[cleanedRefId];
                    if (refNum) {
                        resultHTML += `<sup class="source-ref" data-ref-id="${escapeHtml(cleanedRefId)}">${refNum}</sup>`;
                        if (idx < refIds.length - 1) resultHTML += ',';
                    }
                });
                
                lastIndex = match.index + match[0].length;
            }
            
            resultHTML += escapeHtml(rawContent.substring(lastIndex));
            return { html: resultHTML, numberedSources: sourceIdToNumberMap };
        }

        // 显示版本内容
        function displayVersionContent(versionObj) {
            if (!versionObj) return;
            
            const { html, numberedSources } = parseSourcedContentWithRefs(versionObj.content || "", versionObj.sources || {});
            
            elements.resultTextDisplay.innerHTML = html;
            elements.resultVersionInfo.textContent = `版本: ${versionObj.version} | 更新: ${versionObj.date} by ${versionObj.editor}`;
            
            if (versionObj.notes) {
                elements.resultVersionInfo.textContent += ` | 说明: ${versionObj.notes}`;
            }
            
            if (versionObj.reviewComment) {
                elements.resultVersionInfo.textContent += ` | 审核意见: ${versionObj.reviewComment}`;
            }

            // 更新源列表
            updateSourceList(versionObj.sources || {}, numberedSources);
            
            // 添加源引用事件监听
            attachSourceRefListeners();
        }

        // 更新源列表
        function updateSourceList(sources, numberedSources) {
            elements.sourceListUL.innerHTML = '';
            
            if (Object.keys(sources).length === 0) {
                elements.sourceListUL.innerHTML = '<li class="text-slate-400 italic">暂无来源信息</li>';
                return;
            }

            const sortedSources = Object.entries(sources)
                .sort(([idA, _A], [idB, _B]) => (numberedSources[idA] || 0) - (numberedSources[idB] || 0));

            sortedSources.forEach(([id, source]) => {
                const refNum = numberedSources[id];
                if (!refNum) return;

                const li = document.createElement('li');
                li.className = 'source-list-item p-2 hover:bg-slate-100 rounded cursor-pointer';
                li.innerHTML = `
                    <div class="flex items-start">
                        <span class="font-medium mr-2">[${refNum}]</span>
                        <div class="flex-1">
                            <div class="text-slate-700">${escapeHtml(source.displayText || '')}</div>
                            ${source.docSnippet ? `
                                <div class="text-slate-500 text-xs mt-1">${escapeHtml(source.docSnippet)}</div>
                            ` : ''}
                        </div>
                    </div>
                `;
                li.addEventListener('click', () => handleSourceClick(source));
                elements.sourceListUL.appendChild(li);
            });
        }

        // 处理源点击
        function handleSourceClick(source) {
            if (!source) return;

            if (source.type === 'doc') {
                // 处理文档内源引用
                if (source.page) {
                    // 在实际应用中，这里应该调用PDF查看器的API跳转到指定页面
                    console.log(`跳转到第 ${source.page} 页`);
                }
                if (source.rect) {
                    // 在实际应用中，这里应该高亮显示指定区域
                    console.log(`高亮区域: ${source.rect}`);
                }
            } else if (source.type === 'url') {
                // 处理URL类型的源
                if (source.link) {
                    window.open(source.link, '_blank');
                }
            }
        }

        // 添加源引用事件监听
        function attachSourceRefListeners() {
            document.querySelectorAll('.source-ref').forEach(ref => {
                ref.addEventListener('click', (e) => {
                    const refId = e.target.dataset.refId;
                    const source = displayedVersion.sources[refId];
                    if (source) {
                        handleSourceClick(source);
                    }
                });
            });
        }

        // --- 事件监听器 ---
        elements.copyResultBtn.addEventListener('click', copyResultContent);
        elements.exportResultBtn.addEventListener('click', exportResult);
        elements.reviewResultBtn.addEventListener('click', () => enterEditMode());
        elements.saveChangesBtn.addEventListener('click', saveChanges);
        elements.cancelEditBtn.addEventListener('click', exitEditMode);
        elements.approveResultBtn.addEventListener('click', () => reviewResult(true));

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 从URL获取结果ID
            const urlParams = new URLSearchParams(window.location.search);
            const resultId = urlParams.get('id');
            
            if (resultId && mockResultDetailsStore[resultId]) {
                currentResultId = resultId;
                currentResultData = mockResultDetailsStore[resultId];
                displayedVersion = currentResultData.versions[0];
                updateUI();
                displayVersionContent(displayedVersion);
            } else {
                // 默认加载或错误处理
                elements.resultMainTitle.textContent = `结果详情: ${resultId ? '无效ID' : '未指定ID'}`;
                elements.resultStatusBadge.innerHTML = getStatusBadgeHTML('error');
                elements.resultTextDisplay.innerHTML = '<div class="text-red-500">未找到结果数据，请检查ID是否正确</div>';
            }
        });
    </script>
</body>
</html>