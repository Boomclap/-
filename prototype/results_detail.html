<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>结果详情 - 信息溯源 (编号)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        .status-badge-lg { padding: 0.3rem 0.8rem; font-size: 0.8rem; border-radius: 0.375rem; font-weight: 500; }
        .status-pending { background-color: #fef3c7; color: #b45309; }
        .status-approved { background-color: #d1fae5; color: #047857; }
        .status-rejected { background-color: #fee2e2; color: #b91c1c; }
        .version-item.active { background-color: #e0f2fe; border-left-color: #0ea5e9; }
        .result-content-display { white-space: pre-wrap; word-wrap: break-word; line-height: 1.8; } 
        #original-doc-iframe { min-height: calc(100vh - 150px); } /* Adjusted for header height */
        .pane-transition { transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }

        .source-ref {
            font-size: 0.7em; font-weight: 600; padding: 0.5px 2.5px; border-radius: 3px;
            background-color: #e0e7ff; color: #3730a3; cursor: pointer;
            margin-left: 2px; vertical-align: super; line-height: 1; position: relative; 
            transition: background-color 0.2s, color 0.2s;
        }
        .source-ref:hover, .source-ref:focus-visible { background-color: #3730a3; color: white; outline: none; }
        
        .ref-tooltip {
            visibility: hidden; width: 320px; background-color: #1f2937; 
            color: #f9fafb; text-align: left; border-radius: 6px;
            padding: 10px 12px; position: absolute; z-index: 999;
            bottom: 160%; left: 50%; transform: translateX(-50%);
            opacity: 0; transition: opacity 0.2s, visibility 0.2s;
            font-size: 0.78rem; line-height: 1.5; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            pointer-events: none; 
        }
        .source-ref:hover .ref-tooltip, .source-ref:focus-visible .ref-tooltip { visibility: visible; opacity: 1; pointer-events: auto; }
        .ref-tooltip::after {
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid; border-color: #1f2937 transparent transparent transparent;
        }
        .ref-tooltip strong { color: #9ca3af; display: block; margin-bottom: 3px;}
        .ref-tooltip a { color: #60a5fa; text-decoration: underline; }
        .ref-tooltip a:hover { color: #93c5fd; }
        .ref-tooltip .source-text-snippet {
            display: block; background-color: #4a5568; padding: 5px; border-radius: 3px; margin-top: 4px;
            max-height: 60px; overflow-y: auto; font-style: italic; font-size: 0.75rem;
        }

        .collapsible-panel { transition: max-height 0.35s cubic-bezier(0.25, 0.1, 0.25, 1), padding-top 0.35s, padding-bottom 0.35s, border-top-width 0.35s, margin-bottom 0.35s; overflow: hidden; }
        .collapsible-panel.collapsed { max-height: 0px !important; padding-top: 0 !important; padding-bottom: 0 !important; border-top-width: 0 !important; margin-bottom: 0 !important; }
        
        #source-list-panel { max-height: 250px; }
        #version-history-panel { max-height: 200px; }

        .source-list-item { /* Basic styling, can be enhanced */ }
        .pdf-highlight-overlay { /* Placeholder */ }
        .pdf-page-indicator { /* Placeholder */ }
    </style>
</head>
<body class="bg-slate-100 font-sans">
    <div class="flex flex-col h-screen">
        <header class="bg-white shadow-sm p-3 border-b border-slate-200 flex-shrink-0">
             <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center min-w-0">
                    <h1 id="result-main-title" class="text-lg font-semibold text-slate-800 truncate mr-4" title="结果详情: 加载中...">结果详情: 加载中...</h1>
                </div>
                <div class="flex items-center space-x-2" id="header-actions-buttons">
                    <button id="copy-result-btn" title="复制结果内容" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md flex items-center">
                        <i class="fas fa-copy mr-1.5"></i> 复制
                    </button>
                    <button id="export-result-btn" title="导出结果" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md flex items-center">
                        <i class="fas fa-file-export mr-1.5"></i> 导出
                    </button>
                    <button id="review-result-btn" title="审核结果" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md flex items-center">
                        <i class="fas fa-check-double mr-1.5"></i> 审核
                    </button>
                    <button id="toggle-original-doc-btn" title="切换原始文献显隐" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md flex items-center">
                        <i class="fas fa-eye-slash mr-1.5"></i> <span id="toggle-doc-text">隐藏原文</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 flex flex-col md:flex-row overflow-hidden p-3 gap-3">
            <div id="left-pane" class="w-full md:w-1/2 flex flex-col bg-white rounded-lg shadow overflow-hidden pane-transition">
                <div class="p-4 border-b border-slate-200 flex-shrink-0">
                    <div class="flex justify-between items-center mb-1">
                        <h2 class="text-base font-semibold text-slate-700">结果内容 
                            <span class="text-xs text-slate-400 font-normal">(点击<sup class="source-ref !bg-transparent !text-blue-500 !p-0 !font-bold">#</sup>查看来源)</span>
                        </h2>
                        <span id="result-status-badge" class="status-badge-lg">加载中</span>
                    </div>
                    <p id="result-version-info" class="text-xs text-slate-500">版本: - | 更新: -</p>
                </div>

                <div id="result-content-area" class="p-4 flex-grow overflow-y-auto custom-scrollbar">
                    <div id="result-text-display" class="text-sm text-slate-700 result-content-display">加载中...</div>
                    <textarea id="result-text-edit" class="hidden w-full h-full text-sm border border-slate-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 custom-scrollbar" rows="10" placeholder="在此编辑结果内容。使用 [[文本内容|refs:sourceId1,sourceId2]] 格式添加溯源。\n源定义在版本数据中，例如：s1, s2..."></textarea>
                </div>
                
                <div id="edit-specific-actions" class="p-3 border-t border-slate-200 bg-slate-50 hidden flex-shrink-0">
                     <div class="mb-2">
                         <label for="revision-notes" class="block text-xs font-medium text-slate-600 mb-1">修改说明 (可选)</label>
                         <input type="text" id="revision-notes" class="w-full text-xs p-1.5 border border-slate-300 rounded-md focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button id="cancel-edit-btn" class="px-3 py-1.5 text-xs font-medium text-slate-700 bg-slate-200 hover:bg-slate-300 rounded-md">取消</button>
                        <button id="save-changes-btn" class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">保存修改</button>
                        <button id="approve-result-btn" class="px-3 py-1.5 text-xs font-medium text-white bg-green-600 hover:bg-green-700 rounded-md">审核通过</button>
                    </div>
                </div>
                
                <div id="source-list-panel-wrapper" class="flex-shrink-0 border-t border-slate-200">
                    <button id="toggle-source-list-btn" class="w-full text-left p-2 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 focus:outline-none flex justify-between items-center">
                        <span>参考文献/来源列表</span>
                        <i id="source-list-caret" class="fas fa-chevron-up transition-transform"></i> 
                    </button>
                    <div id="source-list-panel" class="collapsible-panel p-3 bg-slate-50 overflow-y-auto custom-scrollbar collapsed">
                        <ul id="source-list-ul" class="text-xs space-y-1.5">
                            <li class="text-slate-400 italic">暂无来源信息或未加载。</li>
                        </ul>
                    </div>
                </div>

                <div id="version-history-wrapper" class="flex-shrink-0 border-t border-slate-200">
                    <button id="toggle-version-history-btn" class="w-full text-left p-2 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 focus:outline-none flex justify-between items-center">
                        <span>修改历史</span>
                        <i id="version-history-caret" class="fas fa-chevron-up transition-transform"></i> 
                    </button>
                    <div id="version-history-panel" class="collapsible-panel p-3 bg-slate-50/50 overflow-y-auto custom-scrollbar collapsed">
                        <ul id="version-history-list" class="space-y-1.5 text-xs">
                            <li class="text-slate-500">加载中...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="right-pane" class="w-full md:w-1/2 bg-white rounded-lg shadow overflow-hidden flex flex-col pane-transition relative">
                <div class="p-3 border-b border-slate-200 bg-slate-50 flex justify-between items-center flex-shrink-0">
                    <h2 class="text-base font-semibold text-slate-700">原始文献</h2>
                </div>
                <div class="p-1 flex-grow custom-scrollbar overflow-auto relative bg-slate-200">
                    <iframe id="original-doc-iframe" src="" class="w-full h-full border-none" title="Original Document"></iframe>
                    <div id="pdf-highlight-overlay" class="pdf-highlight-overlay hidden"></div>
                    <div id="pdf-page-indicator" class="pdf-page-indicator hidden">Page ?</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Mock Data ---
        const mockResultDetailsStore = {
            "res001": { 
                name: "白芍文献1的有效成分及药理作用分析结果", 
                status: "approved", 
                originalDocUrl: "https://www.africau.edu/images/default/sample.pdf", 
                currentVersion: "v1.3",
                versions: [
                    { 
                        version: "v1.3", 
                        date: "2025-02-20", 
                        editor: "张三", 
                        notes: "更新为编号引用格式", 
                        content: "文献明确指出[[白芍总苷具有显著的抗炎、镇痛双重药理作用|refs:s1]]。其主要活性成分包括[[芍药苷|refs:s1]]和羟基芍药苷等。这些发现与[[一项重要的外部研究|refs:s2]]的结果相符。因此，综合来看，[[白芍作为传统中药，其药用价值得到了现代药理学的支持|refs:s1]]。这句话同时参考了[[文献和外部链接|refs:s1,s2]]。",
                        sources: {
                            "s1": { type: "doc", page: 2, rect: "50,100,300,40", sel: "段落开头'白芍总苷...'", displayText: "本文献，第 2 页，高亮区域", docSnippet: "白芍总苷具有显著的抗炎、镇痛双重药理作用，对多种炎症模型均显示出良好的抑制效果..." },
                            "s2": { type: "url", link: "https://pubmed.ncbi.nlm.nih.gov/12345678/", displayText: "外部研究: PubMed ID 12345678" },
                        }, 
                        approved: true,
                        reviewComment: "内容准确，引用规范",
                        reviewDate: "2025-02-21",
                        reviewer: "李四"
                    }
                    // Older versions can be added here if needed
                ]
            },
            "res002": {
                name: "白芍文献2的核心观点提炼",
                status: "pending", 
                originalDocUrl: "https://www.africau.edu/images/default/sample.pdf", 
                currentVersion: "v1.0",
                versions: [
                    {
                        version: "v1.0",
                        date: "2025-02-18", 
                        editor: "赵六", 
                        notes: "初步提炼",
                        content: "[[白芍文献2的主要观点是白芍对特定细胞通路的影响|refs:s1]]。进一步研究表明[[其作用机制涉及多个靶点|refs:s2]]。该文献还讨论了[[临床应用的潜在挑战与机遇|refs:s3]]。",
                        sources: {
                            "s1": { type: "doc", page: 1, displayText: "文献2第1页摘要" },
                            "s2": { type: "doc", page: 3, displayText: "文献2第3页讨论部分", docSnippet: "作用机制复杂，涉及多个信号通路..." },
                            "s3": { type: "url", link: "https://example.com/clinicaltrials/baishao", displayText: "相关临床试验注册信息" }
                        },
                        approved: false
                    }
                ]
            },
            "res003": {
                name: "综述：IBD治疗中草药应用前景分析",
                status: "rejected",
                originalDocUrl: "https://www.africau.edu/images/default/sample.pdf",
                currentVersion: "v1.0",
                versions: [
                    {
                        version: "v1.0",
                        date: "2025-01-20",
                        editor: "孙八",
                        notes: "初版提交",
                        content: "研究表明[[多种中草药在IBD治疗中显示出较好的效果|refs:s1]]。特别是[[黄芩素对肠道炎症的抑制作用显著|refs:s2]]。然而，[[临床应用仍存在剂量标准化等问题|refs:s3]]。",
                        sources: {
                            "s1": { type: "doc", page: 1, rect: "100,150,300,30", displayText: "文献第1页", docSnippet: "多项研究表明，草药如黄芩、白术等在IBD的治疗中显示出较好的临床效果..." },
                            "s2": { type: "url", link: "https://example.com/research/ibd", displayText: "外部研究：黄芩素功效分析" },
                            "s3": { type: "doc", page: 3, displayText: "文献第3页结论部分" }
                        },
                        approved: false, // This version was rejected
                        reviewComment: "内容有误，参考文献不足，需要补充更多临床研究证据",
                        reviewDate: "2025-01-25",
                        reviewer: "钱七"
                    }
                ]
            },
             "res004": {
                name: "北豆根化学成分研究进展摘要",
                status: "approved", 
                originalDocUrl: "https://www.africau.edu/images/default/sample.pdf", 
                currentVersion: "v1.1", // Assuming v1.1 is the approved one
                versions: [
                     {
                        version: "v1.1",
                        date: "2025-03-02", 
                        editor: "周吴", 
                        notes: "已审核校对，补充引用",
                        content: "[[北豆根包含多种生物碱，如生物碱A、B等|refs:s1]]，具有[[潜在的抗肿瘤和抗炎药用价值|refs:s2]]。[[进一步研究集中在其作用机制和临床转化上|refs:s3]]。",
                        sources: {
                            "s1": { type: "doc", page: 1, displayText: "进展摘要 第1页 - 化学成分" },
                            "s2": { type: "doc", page: 2, displayText: "进展摘要 第2页 - 药理活性" },
                            "s3": { type: "url", link: "https://example.com/beidougen-review", displayText: "北豆根综述文章"}
                        },
                        approved: true,
                        reviewComment: "内容准确，符合要求。",
                        reviewDate: "2025-03-03",
                        reviewer: "系统管理员" // Placeholder for reviewer
                    },
                    {
                        version: "v1.0",
                        date: "2025-03-01", 
                        editor: "郑王", 
                        notes: "初稿摘要",
                        content: "[[北豆根包含多种生物碱|refs:s1]]，初步显示[[药用价值|refs:s2]]。",
                        sources: {
                            "s1": { type: "doc", page: 1, displayText: "进展摘要 第1页" },
                            "s2": { type: "doc", page: 2, displayText: "进展摘要 第2页" }
                        },
                        approved: false
                    }
                ]
            },
            "res005": {
                name: "巴豆相关毒理学研究数据提取",
                status: "pending", 
                originalDocUrl: "https://www.africau.edu/images/default/sample.pdf", 
                currentVersion: "v1.0",
                versions: [
                    {
                        version: "v1.0",
                        date: "2025-03-05", 
                        editor: "褚卫", 
                        notes: "数据初步提取，待复核",
                        content: "[[巴豆油的主要毒性成分为巴豆毒素 (phorbol esters)|refs:s1]]。[[小鼠口服LD50数据约为 X mg/kg|refs:s2]]。[[皮肤接触可引起严重刺激反应|refs:s1]]。",
                        sources: {
                            "s1": { type: "doc", page: 4, displayText: "毒理学文献 第4页 - 成分与反应" },
                            "s2": { type: "url", link: "https://example.com/toxnet/croton-ld50", displayText: "ToxNet: Croton Oil LD50 Data" }
                        },
                        approved: false
                    }
                ]
            }
        };
        
        // --- DOM Elements ---
        let currentResultId = null;
        let currentResultData = null;
        let displayedVersion = null;
        let isEditMode = false;
        let isOriginalDocVisible = true; 

        const elements = {
            resultMainTitle: document.getElementById('result-main-title'),
            resultStatusBadge: document.getElementById('result-status-badge'),
            resultVersionInfo: document.getElementById('result-version-info'),
            resultTextDisplay: document.getElementById('result-text-display'),
            resultTextEdit: document.getElementById('result-text-edit'),
            editSpecificActions: document.getElementById('edit-specific-actions'),
            revisionNotesInput: document.getElementById('revision-notes'),
            headerActionsButtons: document.getElementById('header-actions-buttons'),
            versionHistoryList: document.getElementById('version-history-list'),
            originalDocIframe: document.getElementById('original-doc-iframe'),
            leftPane: document.getElementById('left-pane'),
            rightPane: document.getElementById('right-pane'),
            toggleOriginalDocBtn: document.getElementById('toggle-original-doc-btn'),
            toggleDocText: document.getElementById('toggle-doc-text'),
            sourceListUL: document.getElementById('source-list-ul'),
            copyResultBtn: document.getElementById('copy-result-btn'),
            exportResultBtn: document.getElementById('export-result-btn'),
            reviewResultBtn: document.getElementById('review-result-btn'),
            saveChangesBtn: document.getElementById('save-changes-btn'),
            approveResultBtn: document.getElementById('approve-result-btn'),
            cancelEditBtn: document.getElementById('cancel-edit-btn'),
            toggleSourceListBtn: document.getElementById('toggle-source-list-btn'),
            sourceListPanel: document.getElementById('source-list-panel'),
            sourceListCaret: document.getElementById('source-list-caret'),
            toggleVersionHistoryBtn: document.getElementById('toggle-version-history-btn'),
            versionHistoryPanel: document.getElementById('version-history-panel'),
            versionHistoryCaret: document.getElementById('version-history-caret')
        };

        // --- 功能函数 ---
        
        function copyResultContent() {
            const contentToCopy = displayedVersion ? displayedVersion.content : elements.resultTextDisplay.textContent;
            navigator.clipboard.writeText(contentToCopy).then(() => {
                showToast('结果内容已复制到剪贴板');
            }).catch(err => {
                console.error('复制失败:', err);
                showToast('复制失败，请重试', 'error');
            });
        }

        function exportResult() {
            if (!displayedVersion) {
                showToast('无版本信息可导出', 'error');
                return;
            }
            const exportData = {
                id: currentResultId,
                name: currentResultData.name,
                version: displayedVersion.version,
                content: displayedVersion.content,
                sources: displayedVersion.sources,
                exportDate: new Date().toISOString(),
                status: currentResultData.status, // Overall status of the result
                versionStatus: displayedVersion.approved ? 'approved' : (displayedVersion.reviewComment ? 'rejected' : 'pending')
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `result_${currentResultId}_${displayedVersion.version}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('结果已导出');
        }

        function enterEditMode() {
            if (displayedVersion && displayedVersion.approved) {
                showToast('此版本已审核通过，无法直接修改或再次审核。', 'info');
                return;
            }
            isEditMode = true;
            elements.resultTextDisplay.classList.add('hidden');
            elements.resultTextEdit.classList.remove('hidden');
            elements.editSpecificActions.classList.remove('hidden');
            elements.resultTextEdit.value = displayedVersion ? displayedVersion.content : '';
            elements.revisionNotesInput.value = '';
            elements.reviewResultBtn.disabled = true; // Disable while in edit mode
            elements.approveResultBtn.disabled = false; // Enable approve button in edit panel
            showToast('已进入编辑模式');
        }

        function exitEditMode() {
            isEditMode = false;
            elements.resultTextDisplay.classList.remove('hidden');
            elements.resultTextEdit.classList.add('hidden');
            elements.editSpecificActions.classList.add('hidden');
            // Re-evaluate reviewResultBtn state based on displayedVersion
            if (displayedVersion) {
                 elements.reviewResultBtn.disabled = displayedVersion.approved;
            } else {
                elements.reviewResultBtn.disabled = true; // No version, can't review
            }
            displayVersionContent(displayedVersion); // Refresh display
        }

        function saveChanges() {
            const newContent = elements.resultTextEdit.value;
            const revisionNotes = elements.revisionNotesInput.value.trim();
            
            if (!displayedVersion) {
                showToast('错误：无当前版本信息以保存修改。', 'error');
                return;
            }

            // Create new version
            const versionParts = displayedVersion.version.substring(1).split('.').map(Number);
            versionParts[versionParts.length -1]++; // Increment minor version
            const newVersionNumber = `v${versionParts.join('.')}`;

            const newVersion = {
                version: newVersionNumber,
                date: new Date().toISOString().split('T')[0],
                editor: "当前用户", 
                notes: revisionNotes || `基于 ${displayedVersion.version} 修改`,
                content: newContent,
                sources: JSON.parse(JSON.stringify(displayedVersion.sources || {})), // Deep copy sources
                approved: false // New versions are not approved by default
            };

            currentResultData.versions.unshift(newVersion); // Add to the beginning (most recent)
            currentResultData.currentVersion = newVersion.version;
            currentResultData.status = 'pending'; // Result status becomes pending due to new unapproved version
            
            switchToVersion(newVersion.version); // Switch to display this new version
            
            exitEditMode();
            updateUI(); // Update overall UI, including status badge
            showToast('修改已保存为新版本 ' + newVersion.version);
        }
        
        function reviewResultModal(isApproved) {
            // Prevent review if already approved and trying to approve again, or if no version
            if (!displayedVersion) {
                 showToast('没有可审核的版本。', 'error');
                 return;
            }
            if (isApproved && displayedVersion.approved) {
                showToast('此版本已审核通过。', 'info');
                return;
            }
             if (!isApproved && currentResultData.status === 'rejected' && displayedVersion.version === currentResultData.versions.find(v => v.reviewComment)?.version) {
                showToast('此版本已审核不通过。', 'info');
                return;
            }


            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[900]'; // High z-index
            dialog.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-lg w-full mx-4 shadow-xl">
                    <h3 class="text-lg font-semibold mb-4">${isApproved ? '审核通过确认' : '审核不通过确认'}</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="review-comment-modal">审核说明 (${isApproved ? '可选' : '必填'})</label>
                        <textarea id="review-comment-modal" class="w-full border rounded-md p-2 text-sm" rows="3" placeholder="${isApproved ? '选填审核通过的说明...' : '请填写不通过的原因...'}"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button class="px-4 py-2 text-sm text-slate-600 bg-slate-100 hover:bg-slate-200 rounded-md" onclick="this.closest('.fixed').remove()">取消</button>
                        <button id="confirm-review-btn" class="px-4 py-2 text-sm text-white ${isApproved ? 'bg-green-600 hover:bg-green-700' : 'bg-red-600 hover:bg-red-700'} rounded-md">确认</button>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
            dialog.querySelector('#confirm-review-btn').addEventListener('click', () => {
                const comment = dialog.querySelector('#review-comment-modal').value.trim();
                if (!isApproved && !comment) {
                    showToast('审核不通过必须填写说明。', 'error');
                    dialog.querySelector('#review-comment-modal').focus();
                    return;
                }
                submitReview(isApproved, comment);
                dialog.remove();
            });
        }


        function submitReview(isApproved, comment) {
            if (!displayedVersion) {
                showToast('错误：无当前版本信息。', 'error');
                return;
            }
            
            displayedVersion.approved = isApproved;
            displayedVersion.reviewComment = comment;
            displayedVersion.reviewDate = new Date().toISOString().split('T')[0];
            displayedVersion.reviewer = "当前用户"; 
            
            currentResultData.status = isApproved ? 'approved' : 'rejected';
            
            updateUI(); // Update overall UI including status and version list
            displayVersionContent(displayedVersion); // Refresh current version display
            showToast(`版本 ${displayedVersion.version} 审核${isApproved ? '通过' : '不通过'}已提交`);
            exitEditMode(); // Ensure edit mode is exited
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg text-white shadow-lg 
                ${type === 'success' ? 'bg-green-600' : (type === 'error' ? 'bg-red-600' : 'bg-blue-600')} 
                transition-all duration-300 ease-out z-[1000] transform translate-y-10 opacity-0`;
            toast.textContent = message;
            document.body.appendChild(toast);

            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-10', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
            });
            
            setTimeout(() => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function updateVersionHistoryList() {
            if (!currentResultData || !currentResultData.versions) {
                elements.versionHistoryList.innerHTML = '<li class="text-slate-500 italic">无版本历史。</li>';
                return;
            }
            const versions = currentResultData.versions; // Assumes versions are sorted newest first
            elements.versionHistoryList.innerHTML = versions.map((ver) => `
                <li class="version-item ${ver.version === displayedVersion.version ? 'active' : ''} p-2.5 border-l-4 ${ver.version === displayedVersion.version ? 'border-blue-500 bg-blue-50' : 'border-transparent'} hover:bg-slate-100 cursor-pointer rounded-r-md"
                    onclick="switchToVersion('${ver.version}')">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="font-semibold text-slate-700">${ver.version}</span>
                            <span class="text-slate-500 ml-2 text-xs">${ver.date} by ${ver.editor}</span>
                        </div>
                        ${ver.approved !== undefined ? `
                            <span class="text-xs status-badge-lg text-xs px-1.5 py-0.5 ${ver.approved ? 'status-approved' : (ver.reviewComment ? 'status-rejected' : 'status-pending')}">
                                ${ver.approved ? '已通过' : (ver.reviewComment ? '未通过' : '待审')}
                            </span>
                        ` : '<span class="text-xs status-badge-lg status-pending px-1.5 py-0.5">待审</span>'}
                    </div>
                    <div class="text-slate-600 mt-1 text-xs">${ver.notes || '无修改说明'}</div>
                    ${ver.reviewComment ? `
                        <div class="text-slate-500 mt-1 text-xs italic">
                            审核意见 (${ver.reviewDate} by ${ver.reviewer}): ${escapeHtml(ver.reviewComment)}
                        </div>
                    ` : ''}
                </li>
            `).join('');
        }

        function switchToVersion(versionId) {
            const version = currentResultData.versions.find(v => v.version === versionId);
            if (version) {
                displayedVersion = version;
                displayVersionContent(version);
                updateVersionHistoryList(); // Re-render to highlight active version
                 // Update overall status badge if the switched version dictates it (e.g. if it's the latest)
                if (version.version === currentResultData.currentVersion) {
                    elements.resultStatusBadge.innerHTML = getStatusBadgeHTML(currentResultData.status);
                } else { // For older versions, show their specific approval status
                     elements.resultStatusBadge.innerHTML = getStatusBadgeHTML(version.approved ? 'approved' : (version.reviewComment ? 'rejected' : 'pending'));
                }
            }
        }
        
        function updateUI() {
            if (!currentResultData) return;
            elements.resultMainTitle.textContent = `结果详情: ${currentResultData.name}`;
            elements.resultStatusBadge.innerHTML = getStatusBadgeHTML(currentResultData.status); // Overall status
            elements.originalDocIframe.src = currentResultData.originalDocUrl || "about:blank";
            updateVersionHistoryList();
        }
        
        function getStatusBadgeHTML(status) {
            const statusMap = {
                'pending': { class: 'status-pending', text: '待审核' },
                'approved': { class: 'status-approved', text: '审核通过' },
                'rejected': { class: 'status-rejected', text: '审核不通过' }
            };
            const statusInfo = statusMap[status] || { class: 'bg-slate-200 text-slate-700', text: status };
            return `<span class="status-badge-lg ${statusInfo.class}">${statusInfo.text}</span>`;
        }
        
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return '';
return unsafe
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");
        }

        function parseSourcedContentWithRefs(rawContent, sources = {}) {
            const regex = /\[\[(.*?)\|refs:([a-zA-Z0-9_,-]+)\]\]/g;
            let resultHTML = "";
            let lastIndex = 0;
            const sourceIdToNumberMap = {};
            let currentRefNumber = 1;

            const sourceEntries = Object.entries(sources);

            for (const match of rawContent.matchAll(regex)) {
                const refIds = match[2].trim().split(',');
                refIds.forEach(refId => {
                    const cleanedRefId = refId.trim();
                    if (sources[cleanedRefId] && !sourceIdToNumberMap[cleanedRefId]) {
                        sourceIdToNumberMap[cleanedRefId] = currentRefNumber++;
                    }
                });
            }
            
            currentRefNumber = 1; // Reset for ordered display in text
            const displayedNumberedSources = {}; // To ensure tooltip also uses consistent numbering

            for (const match of rawContent.matchAll(regex)) {
                const textBefore = rawContent.substring(lastIndex, match.index);
                const inferredText = match[1].trim();
                const refIds = match[2].trim().split(',');
                
                resultHTML += escapeHtml(textBefore);
                resultHTML += `<span class="inferred-text">${escapeHtml(inferredText)}</span>`;

                refIds.forEach((refId, idx) => {
                    const cleanedRefId = refId.trim();
                    const sourceData = sources[cleanedRefId];
                    if (sourceData) {
                        const refNum = sourceIdToNumberMap[cleanedRefId];
                        displayedNumberedSources[cleanedRefId] = refNum; // Store for tooltip consistency
                        
                        let tooltipHTML = `<strong>源 #${refNum}: ${escapeHtml(sourceData.displayText || 'N/A')}</strong>`;
                        if (sourceData.type === 'url' && sourceData.link) {
                            tooltipHTML += `<a href="${escapeHtml(sourceData.link)}" target="_blank" rel="noopener noreferrer">访问链接</a>`;
                        } else if (sourceData.type === 'doc') {
                            tooltipHTML += `<span>文档内引用 (页 ${sourceData.page || 'N/A'})</span>`;
                        }
                        if (sourceData.docSnippet) {
                             tooltipHTML += `<span class="source-text-snippet">${escapeHtml(sourceData.docSnippet)}</span>`;
                        }

                        resultHTML += `<sup class="source-ref" tabindex="0" data-ref-id="${escapeHtml(cleanedRefId)}">${refNum}<span class="ref-tooltip">${tooltipHTML}</span></sup>`;
                        if (idx < refIds.length - 1) resultHTML += ',';
                    }
                });
                
                lastIndex = match.index + match[0].length;
            }
            
            resultHTML += escapeHtml(rawContent.substring(lastIndex));
            return { html: resultHTML, numberedSources: displayedNumberedSources };
        }

        function displayVersionContent(versionObj) {
            if (!versionObj) {
                elements.resultTextDisplay.innerHTML = '<p class="text-slate-500 italic">请选择一个版本查看。</p>';
                elements.resultVersionInfo.textContent = '版本: - | 更新: -';
                elements.reviewResultBtn.disabled = true;
                elements.reviewResultBtn.title = "无版本可审核";
                elements.reviewResultBtn.classList.add('cursor-not-allowed', 'opacity-70');
                updateSourceList({}, {});
                return;
            }
            
            const { html, numberedSources } = parseSourcedContentWithRefs(versionObj.content || "", versionObj.sources || {});
            
            elements.resultTextDisplay.innerHTML = html || '<p class="text-slate-500 italic">此版本无内容。</p>';
            elements.resultVersionInfo.textContent = `版本: ${versionObj.version} | 更新: ${versionObj.date} by ${versionObj.editor}`;
            
            if (versionObj.notes) {
                elements.resultVersionInfo.textContent += ` | 说明: ${escapeHtml(versionObj.notes)}`;
            }
            
            if (versionObj.reviewComment) {
                elements.resultVersionInfo.textContent += ` | 审核意见 (${versionObj.reviewDate} by ${versionObj.reviewer}): ${escapeHtml(versionObj.reviewComment)}`;
            }

            updateSourceList(versionObj.sources || {}, numberedSources);
            attachSourceRefListeners();

            // Disable "审核" button if current version is approved
            if (versionObj.approved) {
                elements.reviewResultBtn.disabled = true;
                elements.reviewResultBtn.title = "此版本已审核通过。";
                elements.reviewResultBtn.classList.add('cursor-not-allowed', 'opacity-70');
            } else {
                elements.reviewResultBtn.disabled = false;
                elements.reviewResultBtn.title = "审核结果";
                elements.reviewResultBtn.classList.remove('cursor-not-allowed', 'opacity-70');
            }
             // Set main status badge based on the displayed version if it's not the absolute latest overall status
            if (versionObj.version !== currentResultData.currentVersion || currentResultData.status === 'pending') {
                 elements.resultStatusBadge.innerHTML = getStatusBadgeHTML(versionObj.approved ? 'approved' : (versionObj.reviewComment ? 'rejected' : 'pending'));
            } else {
                 elements.resultStatusBadge.innerHTML = getStatusBadgeHTML(currentResultData.status);
            }

        }

        function updateSourceList(sources, numberedSources) {
            elements.sourceListUL.innerHTML = '';
            if (Object.keys(sources).length === 0 || Object.keys(numberedSources).length === 0) {
                elements.sourceListUL.innerHTML = '<li class="text-slate-400 italic p-2">暂无来源信息。</li>';
                return;
            }

            const sortedSourceEntries = Object.entries(sources)
                .filter(([id, _source]) => numberedSources[id] !== undefined) // Only include sources that are actually referenced and numbered
                .sort(([idA, _A], [idB, _B]) => numberedSources[idA] - numberedSources[idB]);

            sortedSourceEntries.forEach(([id, source]) => {
                const refNum = numberedSources[id];
                const li = document.createElement('li');
                li.className = 'source-list-item p-2 hover:bg-slate-100 rounded cursor-pointer border-b border-slate-100 last:border-b-0';
                li.innerHTML = `
                    <div class="flex items-start">
                        <span class="font-semibold mr-2 text-blue-600">[${refNum}]</span>
                        <div class="flex-1">
                            <div class="text-slate-700 font-medium">${escapeHtml(source.displayText || '未知来源')}</div>
                            ${source.docSnippet ? `
                                <div class="text-slate-500 text-xs mt-0.5 italic">“${escapeHtml(source.docSnippet)}”</div>
                            ` : ''}
                            ${source.type === 'url' && source.link ? `
                                <a href="${escapeHtml(source.link)}" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:text-blue-700 text-xs underline break-all">${escapeHtml(source.link)}</a>
                            ` : ''}
                             ${source.type === 'doc' && source.page ? `
                                <span class="text-xs text-slate-500">(文档第 ${source.page} 页)</span>
                            ` : ''}
                        </div>
                    </div>
                `;
                li.addEventListener('click', () => handleSourceClick(source));
                elements.sourceListUL.appendChild(li);
            });
             if (elements.sourceListUL.children.length === 0) {
                 elements.sourceListUL.innerHTML = '<li class="text-slate-400 italic p-2">暂无来源信息或未被引用。</li>';
            }
        }

        function handleSourceClick(source) {
            if (!source) return;
            if (!isOriginalDocVisible) { // If doc pane is hidden, show it
                toggleOriginalDocPane();
            }
            showToast(`处理来源: ${source.displayText}`, 'info');
            if (source.type === 'doc') {
                if (source.page) {
                    console.log(`跳转到PDF第 ${source.page} 页`);
                    // Placeholder: actual PDF viewer API call needed
                    elements.originalDocIframe.contentWindow.postMessage({ type: 'SCROLL_TO_PAGE', page: source.page }, '*');

                }
                if (source.rect) {
                    console.log(`高亮PDF区域: ${source.rect}`);
                     elements.originalDocIframe.contentWindow.postMessage({ type: 'HIGHLIGHT_RECT', page: source.page, rect: source.rect.split(',') }, '*');
                }
            } else if (source.type === 'url' && source.link) {
                window.open(source.link, '_blank');
            }
        }

        function attachSourceRefListeners() {
            document.querySelectorAll('.source-ref').forEach(ref => {
                // Remove old listeners if any (simple way)
                const newRef = ref.cloneNode(true);
                ref.parentNode.replaceChild(newRef, ref);

                newRef.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent body click from hiding tooltip immediately
                    const refId = e.currentTarget.dataset.refId;
                    const source = displayedVersion.sources[refId];
                    if (source) {
                        handleSourceClick(source);
                    }
                });
                 newRef.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        e.stopPropagation();
                        const refId = e.currentTarget.dataset.refId;
                        const source = displayedVersion.sources[refId];
                        if (source) {
                            handleSourceClick(source);
                        }
                    }
                });
            });
        }
        
        function toggleOriginalDocPane() {
            isOriginalDocVisible = !isOriginalDocVisible;
            const iconElement = elements.toggleOriginalDocBtn.querySelector('i');

            if (isOriginalDocVisible) { // SHOW the document pane
                elements.rightPane.classList.remove('md:w-0', 'w-0', 'opacity-0', 'pointer-events-none');
                elements.rightPane.classList.add('md:w-1/2', 'w-full');
                elements.leftPane.classList.replace('md:w-full', 'md:w-1/2');
                elements.toggleDocText.textContent = '隐藏原文';
                if (iconElement) {
                    iconElement.classList.remove('fa-eye');
                    iconElement.classList.add('fa-eye-slash');
                }
            } else { // HIDE the document pane
                elements.rightPane.classList.replace('md:w-1/2', 'md:w-0');
                elements.rightPane.classList.replace('w-full', 'w-0');
                elements.rightPane.classList.add('opacity-0', 'pointer-events-none');
                elements.leftPane.classList.replace('md:w-1/2', 'md:w-full');
                elements.toggleDocText.textContent = '显示原文';
                if (iconElement) {
                    iconElement.classList.remove('fa-eye-slash');
                    iconElement.classList.add('fa-eye');
                }
            }
        }

        // --- Event Listeners ---
        elements.copyResultBtn.addEventListener('click', copyResultContent);
        elements.exportResultBtn.addEventListener('click', exportResult);
        elements.reviewResultBtn.addEventListener('click', () => enterEditMode());
        
        elements.saveChangesBtn.addEventListener('click', saveChanges);
        elements.cancelEditBtn.addEventListener('click', exitEditMode);
        elements.approveResultBtn.addEventListener('click', () => reviewResultModal(true)); // This is in edit panel, so it should trigger modal

        elements.toggleOriginalDocBtn.addEventListener('click', toggleOriginalDocPane);

        function setupCollapsiblePanel(toggleBtn, panel, caretIcon) {
            const isCollapsed = panel.classList.contains('collapsed');
            caretIcon.classList.toggle('fa-chevron-up', isCollapsed);
            caretIcon.classList.toggle('fa-chevron-down', !isCollapsed);

            toggleBtn.addEventListener('click', () => {
                const currentlyCollapsed = panel.classList.toggle('collapsed');
                caretIcon.classList.toggle('fa-chevron-up', currentlyCollapsed);
                caretIcon.classList.toggle('fa-chevron-down', !currentlyCollapsed);
            });
        }
        
        if (elements.toggleSourceListBtn) {
            setupCollapsiblePanel(elements.toggleSourceListBtn, elements.sourceListPanel, elements.sourceListCaret);
        }
        if (elements.toggleVersionHistoryBtn) {
            setupCollapsiblePanel(elements.toggleVersionHistoryBtn, elements.versionHistoryPanel, elements.versionHistoryCaret);
        }
        
        // Global click listener to hide tooltips if clicked outside
        document.addEventListener('click', (e) => {
            document.querySelectorAll('.source-ref .ref-tooltip').forEach(tooltip => {
                if (!tooltip.parentElement.contains(e.target)) {
                    // Simple hide, hover/focus will reshow. For robust accessible tooltips, more state management is needed.
                }
            });
        });


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const resultIdParam = urlParams.get('id');
            
            if (resultIdParam && mockResultDetailsStore[resultIdParam]) {
                currentResultId = resultIdParam;
                currentResultData = JSON.parse(JSON.stringify(mockResultDetailsStore[currentResultId])); // Deep copy for mutable store
                
                // Find the version specified by currentVersion or default to the first one
                let versionToDisplay = currentResultData.versions.find(v => v.version === currentResultData.currentVersion);
                if (!versionToDisplay && currentResultData.versions.length > 0) {
                    versionToDisplay = currentResultData.versions[0]; // Default to most recent if currentVersion is invalid
                    currentResultData.currentVersion = versionToDisplay.version;
                }
                displayedVersion = versionToDisplay;

                updateUI(); // Sets title, overall status, iframe, version history
                if (displayedVersion) {
                    displayVersionContent(displayedVersion); // Sets content, version-specific info, source list, review button state
                } else {
                     elements.resultTextDisplay.innerHTML = '<div class="text-orange-500 p-4">警告：未找到指定的当前版本数据。</div>';
                     displayVersionContent(null); // Handle case with no valid version
                }

            } else {
                elements.resultMainTitle.textContent = `结果详情: ${resultIdParam ? '无效ID ('+resultIdParam+')' : '未指定ID'}`;
                elements.resultStatusBadge.innerHTML = getStatusBadgeHTML('error');
                elements.resultTextDisplay.innerHTML = `<div class="text-red-500 p-4">错误：未找到结果数据。请检查ID (${escapeHtml(resultIdParam || 'N/A')}) 是否正确或数据是否存在。</div>`;
                displayVersionContent(null); // Ensure UI is cleared or shows "no data" state
                elements.headerActionsButtons.querySelectorAll('button').forEach(btn => btn.disabled = true); // Disable all actions
            }
        });
    </script>
</body>
</html>