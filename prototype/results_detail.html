<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>结果详情 - 信息溯源 (编号)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        .status-badge-lg { padding: 0.3rem 0.8rem; font-size: 0.8rem; border-radius: 0.375rem; font-weight: 500; }
        .status-pending { background-color: #fef3c7; color: #b45309; }
        .status-approved { background-color: #d1fae5; color: #047857; }
        .status-rejected { background-color: #fee2e2; color: #b91c1c; }
        .version-item.active { background-color: #e0f2fe; border-left-color: #0ea5e9; }
        .result-content-display { white-space: pre-wrap; word-wrap: break-word; line-height: 1.8; } 
        #original-doc-iframe { min-height: calc(100vh - 150px); }
        .pane-transition { transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }

        .source-ref { /* ... (same as before) ... */
            font-size: 0.7em; font-weight: 600; padding: 0.5px 2.5px; border-radius: 3px;
            background-color: #e0e7ff; color: #3730a3; cursor: pointer;
            margin-left: 2px; vertical-align: super; line-height: 1; position: relative; 
            transition: background-color 0.2s, color 0.2s;
        }
        .source-ref:hover, .source-ref:focus-visible { background-color: #3730a3; color: white; outline: none; }
        
        .ref-tooltip {
            visibility: hidden; width: 320px; background-color: #1f2937; 
            color: #f9fafb; text-align: left; border-radius: 6px;
            padding: 10px 12px; position: absolute; z-index: 999; /* Increased z-index */
            bottom: 160%; left: 50%; transform: translateX(-50%);
            opacity: 0; transition: opacity 0.2s, visibility 0.2s;
            font-size: 0.78rem; line-height: 1.5; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            pointer-events: none; 
        }
        .source-ref:hover .ref-tooltip, .source-ref:focus-visible .ref-tooltip { visibility: visible; opacity: 1; pointer-events: auto; }
        .ref-tooltip::after { /* ... (same as before) ... */
            content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px;
            border-width: 6px; border-style: solid; border-color: #1f2937 transparent transparent transparent;
        }
        .ref-tooltip strong { color: #9ca3af; display: block; margin-bottom: 3px;}
        .ref-tooltip a { color: #60a5fa; text-decoration: underline; }
        .ref-tooltip a:hover { color: #93c5fd; }
        .ref-tooltip .source-text-snippet { /* ... (same as before) ... */
            display: block; background-color: #4a5568; padding: 5px; border-radius: 3px; margin-top: 4px;
            max-height: 60px; overflow-y: auto; font-style: italic; font-size: 0.75rem;
        }

        .collapsible-panel { transition: max-height 0.35s cubic-bezier(0.25, 0.1, 0.25, 1); overflow: hidden; }
        .collapsible-panel.collapsed { max-height: 0px !important; padding-top: 0 !important; padding-bottom: 0 !important; border-top-width: 0 !important; margin-bottom: 0 !important; }
        
        #source-list-panel { max-height: 250px; /* Increased default visible height */ }
        #version-history-panel { max-height: 200px; /* Default visible height for version history */ }

        .source-list-item { /* ... (same as before) ... */ }
        .source-list-item .ref-number { /* ... (same as before) ... */ }

        .pdf-highlight-overlay { /* ... (same as before) ... */ }
        .pdf-page-indicator { /* ... (same as before) ... */ }
    </style>
</head>
<body class="bg-slate-100 font-sans">
    <div class="flex flex-col h-screen">
        <header class="bg-white shadow-sm p-3 border-b border-slate-200 flex-shrink-0">
             <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center min-w-0">
                    <h1 id="result-main-title" class="text-lg font-semibold text-slate-800 truncate mr-4" title="结果详情: 加载中...">结果详情: 加载中...</h1>
                </div>
                <div class="flex items-center space-x-2" id="header-actions-buttons">
                    <button id="toggle-original-doc-btn" title="切换原始文献显隐" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md flex items-center">
                        <i class="fas fa-eye-slash mr-1.5"></i> <span id="toggle-doc-text">隐藏原文</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 flex flex-col md:flex-row overflow-hidden p-3 gap-3">
            <div id="left-pane" class="w-full md:w-1/2 flex flex-col bg-white rounded-lg shadow overflow-hidden pane-transition">
                <div class="p-4 border-b border-slate-200 flex-shrink-0">
                    <div class="flex justify-between items-center mb-1">
                        <h2 class="text-base font-semibold text-slate-700">结果内容 
                            <span class="text-xs text-slate-400 font-normal">(点击<sup class="source-ref !bg-transparent !text-blue-500 !p-0 !font-bold">#</sup>查看来源)</span>
                        </h2>
                        <span id="result-status-badge" class="status-badge-lg">加载中</span>
                    </div>
                    <p id="result-version-info" class="text-xs text-slate-500">版本: - | 更新: -</p>
                </div>

                <div id="result-content-area" class="p-4 flex-grow overflow-y-auto custom-scrollbar">
                    <div id="result-text-display" class="text-sm text-slate-700 result-content-display">加载中...</div>
                    <textarea id="result-text-edit" class="hidden w-full h-full text-sm border border-slate-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 custom-scrollbar" rows="10" placeholder="在此编辑结果内容。使用 [[文本内容|refs:sourceId1,sourceId2]] 格式添加溯源。\n源定义在版本数据中，例如：s1, s2..."></textarea>
                </div>
                
                <div id="edit-specific-actions" class="p-3 border-t border-slate-200 bg-slate-50 hidden flex-shrink-0">
                     <div class="mb-2">
                         <label for="revision-notes" class="block text-xs font-medium text-slate-600 mb-1">修改说明 (可选)</label>
                         <input type="text" id="revision-notes" class="w-full text-xs p-1.5 border border-slate-300 rounded-md focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button id="cancel-edit-btn" class="px-3 py-1.5 text-xs font-medium text-slate-700 bg-slate-200 hover:bg-slate-300 rounded-md">取消</button>
                        <button id="save-changes-btn" class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">保存修改</button>
                        <button id="approve-result-btn" class="px-3 py-1.5 text-xs font-medium text-white bg-green-600 hover:bg-green-700 rounded-md">审核通过</button>
                    </div>
                </div>
                
                <div id="source-list-panel-wrapper" class="flex-shrink-0 border-t border-slate-200">
                    <button id="toggle-source-list-btn" class="w-full text-left p-2 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 focus:outline-none flex justify-between items-center">
                        <span>参考文献/来源列表</span>
                        <i id="source-list-caret" class="fas fa-chevron-up transition-transform"></i> 
                    </button>
                    <div id="source-list-panel" class="collapsible-panel p-3 bg-slate-50 overflow-y-auto custom-scrollbar collapsed">
                        <ul id="source-list-ul" class="text-xs space-y-1.5">
                            <li class="text-slate-400 italic">暂无来源信息或未加载。</li>
                        </ul>
                    </div>
                </div>

                <div id="version-history-wrapper" class="flex-shrink-0 border-t border-slate-200">
                    <button id="toggle-version-history-btn" class="w-full text-left p-2 text-xs font-medium text-slate-600 bg-slate-100 hover:bg-slate-200 focus:outline-none flex justify-between items-center">
                        <span>修改历史</span>
                        <i id="version-history-caret" class="fas fa-chevron-up transition-transform"></i> 
                    </button>
                    <div id="version-history-panel" class="collapsible-panel p-3 bg-slate-50/50 overflow-y-auto custom-scrollbar collapsed">
                        <ul id="version-history-list" class="space-y-1.5 text-xs">
                            <li class="text-slate-500">加载中...</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="right-pane" class="w-full md:w-1/2 bg-white rounded-lg shadow overflow-hidden flex flex-col pane-transition relative">
                <div class="p-3 border-b border-slate-200 bg-slate-50 flex justify-between items-center flex-shrink-0">
                    <h2 class="text-base font-semibold text-slate-700">原始文献</h2>
                </div>
                <div class="p-1 flex-grow custom-scrollbar overflow-auto relative bg-slate-200">
                    <iframe id="original-doc-iframe" src="" class="w-full h-full border-none" title="Original Document"></iframe>
                    <div id="pdf-highlight-overlay" class="pdf-highlight-overlay hidden"></div>
                    <div id="pdf-page-indicator" class="pdf-page-indicator">Page ?</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- Mock Data --- (Same as previous complete version)
        const mockResultDetailsStore = {
            "res001": { 
                name: "白芍文献1的有效成分及药理作用分析结果", status: "approved", 
                originalDocUrl: "https://www.africau.edu/images/default/sample.pdf", currentVersion: "v1.3",
                versions: [
                     { version: "v1.3", date: "2025-02-20", editor: "张三", notes: "更新为编号引用格式", 
                       content: "文献明确指出[[白芍总苷具有显著的抗炎、镇痛双重药理作用|refs:s1]]。其主要活性成分包括[[芍药苷|refs:s1]]和羟基芍药苷等。这些发现与[[一项重要的外部研究|refs:s2]]的结果相符。因此，综合来看，[[白芍作为传统中药，其药用价值得到了现代药理学的支持|refs:s3]]。这句话同时参考了[[文献和外部链接|refs:s1,s2]]。",
                       sources: {
                            "s1": { type: "doc", page: 2, rect: "50,100,300,40", sel: "段落开头'白芍总苷...'", displayText: "本文献，第 2 页，高亮区域", docSnippet: "白芍总苷具有显著的抗炎、镇痛双重药理作用，对多种炎症模型均显示出良好的抑制效果..." },
                            "s2": { type: "url", link: "https://pubmed.ncbi.nlm.nih.gov/12345678/", displayText: "外部研究: PubMed ID 12345678" },
                       }, approved: true },
                    { version: "v1.2", date: "2025-02-18", editor: "张三", notes: "添加了旧版溯源信息", content: "文献指出 [[白芍总苷具有抗炎、镇痛作用|source:doc,page:2,rect:50,100,200,30]]。", sources:{}, approved: true }, // Old version might not have new sources structure
                    { version: "v1.1", date: "2025-02-16", editor: "张三", notes: "最终审核通过版 (无溯源)", content: "详细分析结果内容 v1.1...\n- 白芍总苷具有抗炎、镇痛作用。", sources:{}, approved: true },
                ]
            },
            "res002": { name: "白芍文献2的核心观点提炼", status: "pending", originalDocUrl: "https://www.clickdimensions.com/links/TestPDFfile.pdf", currentVersion: "v1.1", versions: [{ version: "v1.1", date: "2025-02-19", editor: "赵六", notes: "更新引用", content: "核心观点：[[白芍有免疫调节价值|refs:srcA]]。需要[[进一步验证|refs:srcB]]。", sources: {"srcA": {type:"doc", page:1, displayText:"本文献第1页"}, "srcB": {type:"reason", text:"文献结论部分提及需要更多实验", displayText:"推理: 文献结论"}}, approved: false }] },
        };
        
        // --- DOM Elements --- (Add new ones for version history panel)
        let currentResultId = null, currentResultData = null, displayedVersion = null, isEditMode = false, isOriginalDocVisible = true;
        const resultMainTitle = document.getElementById('result-main-title'), resultStatusBadge = document.getElementById('result-status-badge'), resultVersionInfo = document.getElementById('result-version-info'), resultTextDisplay = document.getElementById('result-text-display'), resultTextEdit = document.getElementById('result-text-edit'), editSpecificActions = document.getElementById('edit-specific-actions'), revisionNotesInput = document.getElementById('revision-notes'), headerActionsButtons = document.getElementById('header-actions-buttons'), versionHistoryList = document.getElementById('version-history-list'), originalDocIframe = document.getElementById('original-doc-iframe'), leftPane = document.getElementById('left-pane'), rightPane = document.getElementById('right-pane'), toggleOriginalDocBtn = document.getElementById('toggle-original-doc-btn'), toggleDocText = document.getElementById('toggle-doc-text'), toggleDocIcon = toggleOriginalDocBtn.querySelector('i'), pdfHighlightOverlay = document.getElementById('pdf-highlight-overlay'), pdfPageIndicator = document.getElementById('pdf-page-indicator'), sourceListUL = document.getElementById('source-list-ul'), toggleSourceListBtn = document.getElementById('toggle-source-list-btn'), sourceListCaret = document.getElementById('source-list-caret'), sourceListPanel = document.getElementById('source-list-panel');
        
        const toggleVersionHistoryBtn = document.getElementById('toggle-version-history-btn');
        const versionHistoryPanel = document.getElementById('version-history-panel');
        const versionHistoryCaret = document.getElementById('version-history-caret');

        // --- Functions --- (Most are same, updates to interaction handlers and new toggle)
        function getStatusBadgeHTML(status) { /* ... (same) ... */ 
            let badgeClass = '';
            let statusText = status;
            switch (status) {
                case 'pending': badgeClass = 'status-pending'; statusText = '待审核'; break;
                case 'approved': badgeClass = 'status-approved'; statusText = '审核通过'; break;
                case 'rejected': badgeClass = 'status-rejected'; statusText = '审核不通过'; break;
                default: badgeClass = 'bg-slate-200 text-slate-700'; break;
            }
            return `<span class="status-badge-lg ${badgeClass}">${statusText}</span>`;
        }
        function escapeHtml(unsafe) { /* ... (same) ... */ 
             if (typeof unsafe !== 'string') return '';
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
        }
        function parseSourcedContentWithRefs(rawContent, sources = {}) { /* ... (same) ... */ 
            const regex = /\[\[(.*?)\|refs:([a-zA-Z0-9_,-]+)\]\]/g;
            let resultHTML = "";
            let lastIndex = 0;
            const sourceIdToNumberMap = {};
            let currentRefNumber = 1;

            for (const match of rawContent.matchAll(regex)) {
                const refIdsString = match[2].trim();
                refIdsString.split(',').forEach(refId => {
                    const cleanedRefId = refId.trim(); 
                    if (sources[cleanedRefId] && !sourceIdToNumberMap[cleanedRefId]) {
                        sourceIdToNumberMap[cleanedRefId] = currentRefNumber++;
                    }
                });
            }

            for (const match of rawContent.matchAll(regex)) {
                const textBefore = rawContent.substring(lastIndex, match.index);
                const inferredText = match[1].trim();
                const refIdsString = match[2].trim();
                
                resultHTML += escapeHtml(textBefore); 
                resultHTML += `<span class="inferred-highlight">${escapeHtml(inferredText)}</span>`;

                const refIdArray = refIdsString.split(',').map(id => id.trim());

                refIdArray.forEach((refId, idx) => {
                    const source = sources[refId];
                    if (!source) return;
                    const refNum = sourceIdToNumberMap[refId];
                    if (!refNum) return;
                    
                    resultHTML += `<sup class="source-ref" role="button" tabindex="0" aria-label="查看来源 ${refNum}" data-ref-id="${escapeHtml(refId)}">${refNum}</sup>`;
                    if (idx < refIdArray.length - 1) resultHTML += ','; 
                });
                lastIndex = match.index + match[0].length;
            }
            resultHTML += escapeHtml(rawContent.substring(lastIndex));
            return { html: resultHTML, numberedSources: sourceIdToNumberMap };
        }
        function displayVersionContent(versionObj) { /* ... (same) ... */ 
            displayedVersion = versionObj;
            const sourcesForVersion = versionObj.sources || {}; 
            const { html: parsedHtml, numberedSources } = parseSourcedContentWithRefs(versionObj.content || "", sourcesForVersion);
            
            resultTextDisplay.innerHTML = parsedHtml;
            resultVersionInfo.textContent = `版本: ${versionObj.version} | 更新: ${versionObj.date} by ${versionObj.editor}`;
            if (versionObj.notes) resultVersionInfo.textContent += ` | 说明: ${versionObj.notes}`;
            
            if (isEditMode && currentResultData && currentResultData.versions && displayedVersion.version !== currentResultData.versions[0].version) {
                toggleEditMode(false); 
            }
            resultTextEdit.value = versionObj.content || ""; 
            renderSourceList(sourcesForVersion, numberedSources);
            attachSourceRefListeners(sourcesForVersion);
        }
        function renderSourceList(sources, numberedSourcesMap) { /* ... (same) ... */ 
            sourceListUL.innerHTML = '';
            if (Object.keys(sources).length === 0 || Object.keys(numberedSourcesMap).length === 0) {
                sourceListUL.innerHTML = `<li class="text-slate-400 italic">当前结果版本无引用来源。</li>`;
                return;
            }
            const sortedSourceEntries = Object.entries(sources)
                .filter(([id, _]) => numberedSourcesMap[id]) 
                .sort(([idA, _A], [idB, _B]) => numberedSourcesMap[idA] - numberedSourcesMap[idB]);

            sortedSourceEntries.forEach(([id, source]) => {
                const refNum = numberedSourcesMap[id];
                const li = document.createElement('li');
                li.className = 'source-list-item';
                li.setAttribute('data-ref-id', id);
                li.innerHTML = `<span class="ref-number">[${refNum}]</span> ${escapeHtml(source.displayText || `${source.type} source`)}`;
                li.addEventListener('click', () => handleSourceInteraction(source));
                sourceListUL.appendChild(li);
            });
        }
        
        function attachSourceRefListeners(sources) { /* ... (same) ... */ 
            document.querySelectorAll('.source-ref').forEach(el => {
                const refId = el.dataset.refId; 
                const source = sources[refId]; 

                el.removeEventListener('click', sourceRefClickHandlerWrapper);
                el.removeEventListener('keydown', sourceRefKeydownHandlerWrapper);
                el.removeEventListener('mouseenter', sourceRefMouseenterHandlerWrapper);
                el.removeEventListener('mouseleave', sourceRefMouseleaveHandler);
                el.removeEventListener('focus', sourceRefMouseenterHandlerWrapper); 
                el.removeEventListener('blur', sourceRefMouseleaveHandler);  

                if (source) {
                    el.sourceDataForHandler = source; 
                    el.refNumberForHandler = el.textContent; 

                    el.addEventListener('click', sourceRefClickHandlerWrapper);
                    el.addEventListener('keydown', sourceRefKeydownHandlerWrapper);
                    el.addEventListener('mouseenter', sourceRefMouseenterHandlerWrapper);
                    el.addEventListener('mouseleave', sourceRefMouseleaveHandler);
                    el.addEventListener('focus', sourceRefMouseenterHandlerWrapper);
                    el.addEventListener('blur', sourceRefMouseleaveHandler);
                }
            });
        }
        function sourceRefClickHandlerWrapper(event) { 
            handleSourceInteraction(event.currentTarget.sourceDataForHandler);
            hideRefTooltip(); // Hide tooltip on click
        }
        function sourceRefKeydownHandlerWrapper(event) { if (event.key === 'Enter' || event.key === ' ') { event.preventDefault(); handleSourceInteraction(event.currentTarget.sourceDataForHandler); hideRefTooltip(); } }
        function sourceRefMouseenterHandlerWrapper(event) { showRefTooltip(event.currentTarget, event.currentTarget.sourceDataForHandler, event.currentTarget.refNumberForHandler); }
        
        let currentTooltip = null;
        function showRefTooltip(element, source, refNum) { /* ... (same) ... */ 
            if (!source) return; 
            if (currentTooltip) currentTooltip.remove(); 

            let tooltipText = `<strong>源 #${refNum}:</strong> ${escapeHtml(source.displayText) || source.type}<br>`;
            if (source.type === 'doc' && source.docSnippet) {
                tooltipText += `<span class="source-text-snippet">${escapeHtml(source.docSnippet)}</span>`;
            } else if (source.type === 'url' && source.link) { 
                tooltipText += `<a href='${escapeHtml(source.link)}' target='_blank' rel='noopener noreferrer'>${escapeHtml(source.link)}</a>`;
            } else if (source.type === 'reason' && source.text) { 
                tooltipText += `<em>${escapeHtml(source.text)}</em>`;
            }

            currentTooltip = document.createElement('div');
            currentTooltip.className = 'ref-tooltip'; 
            currentTooltip.innerHTML = tooltipText; 
            
            element.appendChild(currentTooltip); 
            currentTooltip.style.visibility = 'visible'; 
            currentTooltip.style.opacity = '1';
        }
        function hideRefTooltip() { /* ... (same) ... */ 
            if (currentTooltip) {
                currentTooltip.style.opacity = '0';
                currentTooltip.style.visibility = 'hidden';
                setTimeout(() => { if (currentTooltip && currentTooltip.style.opacity === '0') currentTooltip.remove(); currentTooltip = null; }, 200); // Delay removal for fade out
            }
        }
        function sourceRefMouseleaveHandler() { hideRefTooltip(); }

        function handleSourceInteraction(source) { /* ... (same, but added hideRefTooltip call inside wrappers) ... */ 
             if (!source) return;
            pdfHighlightOverlay.classList.add('hidden');
            pdfPageIndicator.classList.remove('visible-indicator');

            document.querySelectorAll('#source-list-ul .source-list-item.highlighted').forEach(li => li.classList.remove('highlighted'));
            const sourceIdToHighlight = displayedVersion && displayedVersion.sources ? Object.keys(displayedVersion.sources).find(key => displayedVersion.sources[key] === source) : null;
            if (sourceIdToHighlight) {
                const listItem = sourceListUL.querySelector(`[data-ref-id="${sourceIdToHighlight}"]`);
                if (listItem) {
                     listItem.classList.add('highlighted');
                     listItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }

            if (source.type === 'doc') {
                if (isOriginalDocVisible === false) toggleOriginalDocPane();
                if (source.page) {
                    pdfPageIndicator.textContent = `Page ${source.page}`;
                    pdfPageIndicator.classList.add('visible-indicator');
                    console.log(`Simulating navigation to PDF page: ${source.page}`);
                }
                if (source.rect) { 
                    const rect = source.rect.split(',').map(Number);
                    pdfHighlightOverlay.style.left = `${rect[0]}px`; 
                    pdfHighlightOverlay.style.top = `${rect[1]}px`;  
                    pdfHighlightOverlay.style.width = `${rect[2]}px`;
                    pdfHighlightOverlay.style.height = `${rect[3]}px`;
                    pdfHighlightOverlay.classList.remove('hidden');
                }
                rightPane.style.boxShadow = "0 0 15px 5px rgba(59, 130, 246, 0.4)";
                setTimeout(() => { rightPane.style.boxShadow = ""; }, 1500);
            } else if (source.type === 'url') {
                if (source.link) window.open(source.link, '_blank');
            } else if (source.type === 'reason') {
                if (source.text) alert(`推理依据:\n${source.text}`);
            }
        }
        
        function renderVersionHistory() { /* ... (same) ... */  
            versionHistoryList.innerHTML = '';
            if (!currentResultData || !currentResultData.versions) return;
            currentResultData.versions.forEach(v => {
                const li = document.createElement('li');
                li.className = `p-1.5 rounded-md hover:bg-slate-100 cursor-pointer border-l-2 border-transparent version-item ${displayedVersion && v.version === displayedVersion.version ? 'active' : ''}`;
                li.innerHTML = `<div class="font-medium text-slate-700">版本 ${v.version} <span class="text-xs text-slate-500 font-normal">- ${v.date}</span></div>${v.notes ? `<div class="text-slate-500 truncate" title="${v.notes}">${v.notes}</div>` : ''}`;
                li.onclick = () => {
                    displayVersionContent(v);
                    document.querySelectorAll('#version-history-list .version-item.active').forEach(item => item.classList.remove('active'));
                    li.classList.add('active');
                };
                versionHistoryList.appendChild(li);
            });
        }
        function updateMainActions() { /* ... (same) ... */ }
        function toggleEditMode(enable) { /* ... (same) ... */ }
        function toggleOriginalDocPane() { /* ... (same) ... */ }
        
        function toggleCollapsiblePanel(panelElement, caretElement) {
            panelElement.classList.toggle('collapsed');
            caretElement.classList.toggle('fa-chevron-down');
            caretElement.classList.toggle('fa-chevron-up');
            if (!panelElement.classList.contains('collapsed')) {
                panelElement.style.maxHeight = panelElement.scrollHeight + "px";
            } else {
                panelElement.style.maxHeight = '0px';
            }
        }

        if (toggleSourceListBtn) {
            toggleSourceListBtn.addEventListener('click', () => toggleCollapsiblePanel(sourceListPanel, sourceListCaret));
        }
        if (toggleVersionHistoryBtn) {
            toggleVersionHistoryBtn.addEventListener('click', () => toggleCollapsiblePanel(versionHistoryPanel, versionHistoryCaret));
        }

        function loadResultDetails(resultId) { /* ... (same, ensure initial panel states are set) ... */ 
             currentResultId = resultId;
            currentResultData = mockResultDetailsStore[resultId];

            if (!currentResultData) { /* ... error handling ... */ return; }

            resultMainTitle.textContent = `结果详情: ${currentResultData.name}`;
            resultMainTitle.title = `结果详情: ${currentResultData.name}`;
            resultStatusBadge.innerHTML = getStatusBadgeHTML(currentResultData.status);
            originalDocIframe.src = currentResultData.originalDocUrl || "about:blank";

            if (currentResultData.versions && currentResultData.versions.length > 0) {
                displayVersionContent(currentResultData.versions[0]); 
                renderVersionHistory();
            } else { /* ... handle no versions ... */ }
            updateMainActions();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // ... (same DOMContentLoaded logic for URL params, save, approve, cancel) ...
            // Initialize panel states (e.g., start collapsed)
            [sourceListPanel, versionHistoryPanel].forEach(panel => {
                if (panel && panel.classList.contains('collapsed')) {
                    panel.style.maxHeight = '0px';
                } else if (panel) {
                    // If meant to be open by default and has content, set maxHeight
                    // For this design, they start collapsed (caret up)
                    panel.style.maxHeight = '0px'; // Ensure it respects collapsed class if set
                    panel.classList.add('collapsed'); // Default to collapsed
                    const caret = panel.id === 'source-list-panel' ? sourceListCaret : versionHistoryCaret;
                    if(caret){
                        caret.classList.remove('fa-chevron-down');
                        caret.classList.add('fa-chevron-up');
                    }
                }
            });
             const urlParams = new URLSearchParams(window.location.search);
            const resultIdFromUrl = urlParams.get('id');
            if (resultIdFromUrl) {
                loadResultDetails(decodeURIComponent(resultIdFromUrl));
            } else {
                resultMainTitle.textContent = "结果详情: 无效ID";
                resultMainTitle.title = "结果详情: 无效ID";
                updateMainActions(); 
            }
            if(toggleOriginalDocBtn) toggleOriginalDocBtn.addEventListener('click', toggleOriginalDocPane);
            if(document.getElementById('cancel-edit-btn')) document.getElementById('cancel-edit-btn').onclick = () => toggleEditMode(false);
            if(document.getElementById('save-changes-btn')) document.getElementById('save-changes-btn').onclick = () => { /* ... (save logic as before) ... */ };
            if(document.getElementById('approve-result-btn')) document.getElementById('approve-result-btn').onclick = () => { /* ... (approve logic as before) ... */ };
        });
    </script>
</body>
</html>