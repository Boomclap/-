<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>所有后台任务</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        .table-fixed-layout { table-layout: fixed; }
        
        .status-badge { padding: 0.25rem 0.6rem; font-size: 0.75rem; border-radius: 9999px; font-weight: 500; text-align: center; display: inline-block; min-width: 70px; }
        .status-pending { background-color: #fef3c7; color: #b45309; } 
        .status-processing { background-color: #dbeafe; color: #1d4ed8; } 
        .status-completed { background-color: #d1fae5; color: #047857; } 
        .status-error { background-color: #fee2e2; color: #b91c1c; } 
        .status-cancelled { background-color: #e5e7eb; color: #4b5563; } 

        .progress-bar-container {
            height: 8px; 
            background-color: #e5e7eb; 
            border-radius: 9999px; 
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            border-radius: 9999px; 
            transition: width 0.3s ease-in-out;
        }
        .clickable-task-name {
            cursor: pointer;
            color: #2563eb; /* blue-600 */
        }
        .clickable-task-name:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body class="bg-slate-100 font-sans p-4 md:p-6">
    <div class="container mx-auto">
        <header class="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
            <h1 class="text-2xl font-semibold text-slate-800">所有后台任务</h1>
            <div class="flex items-center space-x-2">
                 <button id="refresh-tasks-btn" class="px-3 py-2 text-sm bg-slate-500 text-white rounded-md hover:bg-slate-600 flex items-center">
                    <i class="fas fa-sync-alt mr-1.5"></i> 刷新列表
                </button>
            </div>
        </header>

        <div class="bg-white p-4 sm:p-6 rounded-lg shadow mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="search-task" class="block text-sm font-medium text-slate-700 mb-1">搜索任务</label>
                    <div class="relative">
                        <input type="text" id="search-task" placeholder="任务名称或ID..." class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm">
                        <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
                    </div>
                </div>
                <div>
                    <label for="status-filter-task" class="block text-sm font-medium text-slate-700 mb-1">状态筛选</label>
                    <select id="status-filter-task" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm bg-white">
                        <option value="">所有状态</option>
                        <option value="pending">待处理</option>
                        <option value="processing">处理中</option>
                        <option value="completed">已完成</option>
                        <option value="error">错误</option>
                        <option value="cancelled">已取消</option>
                    </select>
                </div>
                <div>
                    <label for="type-filter-task" class="block text-sm font-medium text-slate-700 mb-1">任务类型筛选</label>
                    <select id="type-filter-task" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm bg-white">
                        <option value="">所有类型</option>
                        <option value="single_doc_analysis">单篇文献解析</option>
                        <option value="doc_upload_analysis">文献上传解析</option>
                        <option value="batch_doc_upload_analysis">批量文献上传解析</option>
                        <option value="batch_research_analysis">批量调研解析</option>
                        <option value="comprehensive_research_analysis">综合调研解析</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow overflow-x-auto custom-scrollbar">
            <table class="w-full min-w-[1200px] text-sm text-left text-slate-500 table-fixed-layout">
                <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                    <tr>
                        <th scope="col" class="p-3 w-12"><input type="checkbox" id="select-all-tasks" class="form-checkbox h-4 w-4 text-blue-600 border-slate-300 rounded"></th>
                        <th scope="col" class="p-3 w-1/6">任务ID</th>
                        <th scope="col" class="p-3 w-1/3">任务名称</th>
                        <th scope="col" class="p-3 w-24">状态</th>
                        <th scope="col" class="p-3 w-1/6">进度</th>
                        <th scope="col" class="p-3 w-36">创建时间</th>
                        <th scope="col" class="p-3 w-36">完成/更新时间</th>
                        <th scope="col" class="p-3 w-28 text-center">操作</th>
                    </tr>
                </thead>
                <tbody id="tasks-table-body">
                    <!-- Rows populated by JS -->
                </tbody>
            </table>
        </div>
        
        <div id="tasks-pagination-controls" class="mt-6 flex justify-center items-center space-x-1">
            <!-- Pagination populated by JS -->
        </div>
    </div>

    <script>
        const mockTasksData = [
            // Task types: 
            // 'single_doc_analysis' -> literature_research.html?id={relatedId}
            // 'doc_upload_analysis' -> Not clickable
            // 'batch_doc_upload_analysis' -> Not clickable
            // 'batch_research_analysis' -> comprehensive_research.html?batchId={relatedId} (example, page might need adjustment)
            // 'comprehensive_research_analysis' -> comprehensive_research.html?id={relatedId} (example, page needs adjustment)

            { id: "task_sdoc_001", name: "解析文献: 'IBD最新研究进展.pdf'", type: "single_doc_analysis", relatedId: "lit001", status: "processing", progress: 75, createdDate: "2024-03-10 10:00:00", updatedDate: "2024-03-10 10:05:00" },
            { id: "task_upload_001", name: "上传并解析: '白芍化学成分.docx'", type: "doc_upload_analysis", relatedId: "lit002", status: "completed", progress: 100, createdDate: "2024-03-09 14:30:00", updatedDate: "2024-03-09 14:35:00" },
            { id: "task_batchupload_001", name: "批量上传解析: '药材文献包.zip'", type: "batch_doc_upload_analysis", relatedId: "batch_zip_001", status: "processing", progress: 50, createdDate: "2024-03-10 09:00:00", updatedDate: "2024-03-10 09:15:00", isPulsing: true },
            { id: "task_batchres_001", name: "批量调研: 'IBD治疗药物靶点'", type: "batch_research_analysis", relatedId: "batch_ibd_target_001", status: "pending", progress: 0, createdDate: "2024-03-11 11:00:00", updatedDate: "2024-03-11 11:00:00" },
            { id: "task_compres_001", name: "综合调研: '肿瘤免疫治疗新进展'", type: "comprehensive_research_analysis", relatedId: "comp_tumor_immune_001", status: "error", progress: 20, createdDate: "2024-03-08 16:00:00", updatedDate: "2024-03-08 16:02:00", errorMsg: "部分源文献无法访问" },
            { id: "task_sdoc_002", name: "解析文献: '白术药理作用.docx'", type: "single_doc_analysis", relatedId: "lit002_alt", status: "completed", progress: 100, createdDate: "2024-03-01 10:00:00", updatedDate: "2024-03-05 18:00:00" },
            { id: "task_sdoc_003", name: "解析文献: '一个很长的文献名称用于测试截断效果的非常非常长的文献标题.pdf'", type: "single_doc_analysis", relatedId: "lit_long_name_001", status: "pending", progress: 0, createdDate: "2024-03-12 10:00:00", updatedDate: "2024-03-12 10:00:00" },
            { id: "task_compres_002", name: "综合调研: '特定基因与疾病关联性分析'", type: "comprehensive_research_analysis", relatedId: "gene_disease_XYZ", status: "processing", progress: 30, createdDate: "2024-03-12 11:00:00", updatedDate: "2024-03-12 11:05:00", isPulsing: true},

            ...Array.from({length: 12}, (_, i) => {
                const types = ["single_doc_analysis", "doc_upload_analysis", "batch_doc_upload_analysis", "batch_research_analysis", "comprehensive_research_analysis"];
                const randomType = types[Math.floor(Math.random() * types.length)];
                return {
                    id: `task_gen_${i + 1}`,
                    name: `${randomType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())} ${i + 1}`,
                    type: randomType,
                    relatedId: `gen_id_${i + 1}`,
                    status: ["pending", "processing", "completed", "error", "cancelled"][Math.floor(Math.random() * 5)],
                    progress: Math.floor(Math.random() * 101),
                    createdDate: new Date(Date.now() - Math.random() * 1000000000).toISOString().slice(0, 19).replace('T', ' '),
                    updatedDate: new Date(Date.now() - Math.random() * 500000000).toISOString().slice(0, 19).replace('T', ' ')
                };
            })
        ];

        const tasksTableBody = document.getElementById('tasks-table-body');
        const tasksPaginationControls = document.getElementById('tasks-pagination-controls');
        const typeFilterTaskSelect = document.getElementById('type-filter-task');
        
        const itemsPerPageTasks = 10;
        let currentPageTasks = 1;
        let currentTasksSearchTerm = '';
        let currentTasksStatusFilter = '';
        let currentTasksTypeFilter = ''; // New filter state

        function getTaskStatusBadge(status) { /* ... (same as before) ... */ 
             switch (status) {
                case 'pending': return '<span class="status-badge status-pending">待处理</span>';
                case 'processing': return '<span class="status-badge status-processing">处理中</span>';
                case 'completed': return '<span class="status-badge status-completed">已完成</span>';
                case 'error': return '<span class="status-badge status-error">错误</span>';
                case 'cancelled': return '<span class="status-badge status-cancelled">已取消</span>';
                default: return `<span class="status-badge">${status}</span>`;
            }
        }
        function getProgressBar(progress, status, isPulsing = false) { /* ... (same as before) ... */ 
            let bgColorClass = 'bg-blue-500'; 
            if (status === 'completed') bgColorClass = 'bg-green-500';
            else if (status === 'error') bgColorClass = 'bg-red-500';
            else if (status === 'pending' || status === 'cancelled') bgColorClass = 'bg-slate-400';
            
            const pulseClass = (status === 'processing' && isPulsing) ? ' animate-pulse' : '';

            return `
                <div class="flex items-center">
                    <div class="w-full progress-bar-container mr-2">
                        <div class="progress-bar ${bgColorClass}${pulseClass}" style="width: ${progress}%"></div>
                    </div>
                    <span class="text-xs text-slate-500 w-8 text-right">${progress}%</span>
                </div>
            `;
        }

        function openTaskRelatedPage(taskType, taskName, relatedId) {
            if (!window.parent || typeof window.parent.openTab !== 'function') {
                console.error("无法访问父窗口的 openTab 函数。");
                alert("无法打开页面，请在主应用框架内操作。");
                return;
            }

            let pageUrl = '';
            let tabTitle = '';
            let uniqueIdSuffix = relatedId || Date.now().toString(); // Ensure some uniqueness if relatedId is missing

            switch (taskType) {
                case 'single_doc_analysis':
                    pageUrl = `literature_research.html?id=${encodeURIComponent(relatedId)}`;
                    // Extract filename for a more specific title
                    const match = taskName.match(/'([^']+)'/); // Extracts text within single quotes
                    const docName = match ? match[1] : '文献';
                    tabTitle = `单篇解析: ${docName.substring(0, 20)}${docName.length > 20 ? '...' : ''}`;
                    break;
                case 'batch_research_analysis':
                    pageUrl = `comprehensive_research.html?batchId=${encodeURIComponent(relatedId)}`; // Assuming page handles batchId
                    tabTitle = `批量调研: ${taskName.substring(0, 20)}${taskName.length > 20 ? '...' : ''}`;
                    break;
                case 'comprehensive_research_analysis':
                    pageUrl = `comprehensive_research.html?id=${encodeURIComponent(relatedId)}`; // Assuming page handles specific research id
                    tabTitle = `综合调研: ${taskName.substring(0, 20)}${taskName.length > 20 ? '...' : ''}`;
                    break;
                case 'doc_upload_analysis':
                case 'batch_doc_upload_analysis':
                    // Not clickable as per requirement, so this case ideally shouldn't be called
                    // If it is, we do nothing or show a message
                    console.warn(`Task type "${taskType}" is not designed to be clickable.`);
                    return; 
                default:
                    console.warn(`Unknown task type for navigation: ${taskType}`);
                    return;
            }

            if (pageUrl && tabTitle) {
                window.parent.openTab(tabTitle, pageUrl, true, uniqueIdSuffix);
            }
        }
        
        function renderTasksTable() {
            tasksTableBody.innerHTML = '';
            const filteredData = mockTasksData.filter(item => {
                const matchesSearch = currentTasksSearchTerm === '' || 
                                    item.name.toLowerCase().includes(currentTasksSearchTerm.toLowerCase()) ||
                                    item.id.toLowerCase().includes(currentTasksSearchTerm.toLowerCase());
                const matchesStatus = currentTasksStatusFilter === '' || item.status === currentTasksStatusFilter;
                const matchesType = currentTasksTypeFilter === '' || item.type === currentTasksTypeFilter; // New type filter
                return matchesSearch && matchesStatus && matchesType;
            });

            const paginatedData = filteredData.slice((currentPageTasks - 1) * itemsPerPageTasks, currentPageTasks * itemsPerPageTasks);

            if (paginatedData.length === 0) {
                tasksTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-6 text-slate-500">没有符合条件的任务。</td></tr>`;
                renderTasksPagination(0);
                return;
            }

            paginatedData.forEach(item => {
                let taskNameHtml = `<span class="font-medium text-slate-800 truncate" title="${item.name}">${item.name}</span>`;
                const isClickable = ['single_doc_analysis', 'batch_research_analysis', 'comprehensive_research_analysis'].includes(item.type);
                
                if (isClickable && item.relatedId) {
                    // Escape parameters for security in HTML attributes
                    const escapedType = item.type.replace(/"/g, "&quot;");
const escapedName = item.name.replace(/"/g, "&quot;");
const escapedRelatedId = item.relatedId.replace(/"/g, "&quot;");

taskNameHtml = `<span class="font-medium text-slate-800 truncate clickable-task-name" 
                       title="点击查看: ${item.name}" 
                       onclick="openTaskRelatedPage('${escapedType}', '${escapedName}', '${escapedRelatedId}')">
                    ${item.name}
                  </span>`;
                }


                const row = `
                    <tr class="bg-white border-b hover:bg-slate-50">
                        <td class="p-3"><input type="checkbox" class="form-checkbox h-4 w-4 text-blue-600 border-slate-300 rounded task-checkbox" data-id="${item.id}"></td>
                        <td class="p-3 text-slate-600 font-mono text-xs">${item.id}</td>
                        <td class="p-3">${taskNameHtml}</td>
                        <td class="p-3">${getTaskStatusBadge(item.status)}</td>
                        <td class="p-3">${getProgressBar(item.progress, item.status, item.isPulsing)}</td>
                        <td class="p-3 text-slate-500 text-xs">${item.createdDate}</td>
                        <td class="p-3 text-slate-500 text-xs">${item.updatedDate}</td>
                        <td class="p-3 text-center">
                            ${item.status === 'error' ? `<button title="重试任务 ${item.id}" class="text-orange-500 hover:text-orange-700 p-1" onclick="alert('重试任务 ${item.id} (模拟)')"><i class="fas fa-redo-alt"></i></button>` : ''}
                            ${(item.status === 'processing' || item.status === 'pending') ? `<button title="取消任务 ${item.id}" class="text-red-500 hover:text-red-700 p-1" onclick="if(confirm('确定取消任务 ${item.id}?')) alert('取消任务 ${item.id} (模拟)')"><i class="fas fa-times-circle"></i></button>` : ''}
                            <button title="查看任务 ${item.id} 详情 (模拟)" class="text-blue-500 hover:text-blue-700 p-1" onclick="alert('查看任务 ${item.id} 详情 (模拟)')"><i class="fas fa-eye"></i></button>
                        </td>
                    </tr>
                `;
                tasksTableBody.innerHTML += row;
            });
            renderTasksPagination(filteredData.length);
        }

        function renderTasksPagination(totalItems) { /* ... (same as before) ... */ 
            tasksPaginationControls.innerHTML = '';
            const totalPages = Math.ceil(totalItems / itemsPerPageTasks);
            if (totalPages <= 1) return;

            tasksPaginationControls.innerHTML += `<button data-page="${currentPageTasks - 1}" class="px-3 py-1 text-sm rounded-md ${currentPageTasks === 1 ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-600'}" ${currentPageTasks === 1 ? 'disabled' : ''}>< Previous</button>`;
            for (let i = 1; i <= totalPages; i++) {
                tasksPaginationControls.innerHTML += `<button data-page="${i}" class="px-3 py-1 text-sm rounded-md ${i === currentPageTasks ? 'bg-blue-500 text-white' : 'bg-slate-100 hover:bg-slate-200 text-slate-600'}">${i}</button>`;
            }
            tasksPaginationControls.innerHTML += `<button data-page="${currentPageTasks + 1}" class="px-3 py-1 text-sm rounded-md ${currentPageTasks === totalPages ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-slate-100 hover:bg-slate-200 text-slate-600'}" ${currentPageTasks === totalPages ? 'disabled' : ''}>Next ></button>`;
            
            document.querySelectorAll('#tasks-pagination-controls button[data-page]').forEach(button => {
                button.addEventListener('click', (e) => {
                    currentPageTasks = parseInt(e.currentTarget.dataset.page);
                    renderTasksTable();
                });
            });
        }
        
        document.getElementById('search-task').addEventListener('input', (e) => {
            currentTasksSearchTerm = e.target.value;
            currentPageTasks = 1;
            renderTasksTable();
        });
        document.getElementById('status-filter-task').addEventListener('change', (e) => {
            currentTasksStatusFilter = e.target.value;
            currentPageTasks = 1;
            renderTasksTable();
        });
        // Listener for the new type filter
        typeFilterTaskSelect.addEventListener('change', (e) => {
            currentTasksTypeFilter = e.target.value;
            currentPageTasks = 1;
            renderTasksTable();
        });

         document.getElementById('refresh-tasks-btn').addEventListener('click', () => {
            alert("刷新任务列表 (模拟)");
            renderTasksTable(); // Re-render with current filters
        });
        document.getElementById('select-all-tasks').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.task-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = this.checked);
        });

        document.addEventListener('DOMContentLoaded', () => {
            renderTasksTable();
        });
    </script>
</body>
</html>