<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>结果详情</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #a1a1a1; }
        .status-badge-lg { padding: 0.3rem 0.8rem; font-size: 0.8rem; border-radius: 0.375rem; font-weight: 500; }
        .status-pending { background-color: #fef3c7; color: #b45309; }
        .status-approved { background-color: #d1fae5; color: #047857; }
        .status-rejected { background-color: #fee2e2; color: #b91c1c; }
        .version-item.active { background-color: #e0f2fe; border-left-color: #0ea5e9; }
        .result-content-display { white-space: pre-wrap; word-wrap: break-word; }
        #original-doc-iframe { min-height: calc(100vh - 150px); /* Adjust as needed */ }
        .pane-transition { transition: width 0.3s ease-in-out, opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-slate-100 font-sans">
    <div class="flex flex-col h-screen">
        <header class="bg-white shadow-sm p-3 border-b border-slate-200 flex-shrink-0">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center min-w-0">
                    <h1 id="result-main-title" class="text-lg font-semibold text-slate-800 truncate mr-4">结果详情: 加载中...</h1>
                </div>
                <div class="flex items-center space-x-2" id="header-actions-buttons">
                    <!-- Main action buttons will be populated here by updateMainActions -->
                    <button id="toggle-original-doc-btn" title="切换原始文献显隐" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md flex items-center">
                        <i class="fas fa-eye-slash mr-1.5"></i> <span id="toggle-doc-text">隐藏原文</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 flex flex-col md:flex-row overflow-hidden p-3 gap-3">
            <!-- Left Pane: Result Content & History -->
            <div id="left-pane" class="w-full md:w-1/2 flex flex-col bg-white rounded-lg shadow overflow-hidden pane-transition">
                <div class="p-4 border-b border-slate-200 flex-shrink-0">
                    <div class="flex justify-between items-center mb-1">
                        <h2 class="text-base font-semibold text-slate-700">结果内容</h2>
                        <span id="result-status-badge" class="status-badge-lg">加载中</span>
                    </div>
                    <p id="result-version-info" class="text-xs text-slate-500">版本: - | 更新: -</p>
                </div>

                <div id="result-content-area" class="p-4 flex-grow overflow-y-auto custom-scrollbar">
                    <pre id="result-text-display" class="text-sm text-slate-700 result-content-display">加载中...</pre>
                    <textarea id="result-text-edit" class="hidden w-full h-full text-sm border border-slate-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500 custom-scrollbar" rows="10"></textarea>
                </div>
                
                <div id="edit-specific-actions" class="p-3 border-t border-slate-200 bg-slate-50 hidden flex-shrink-0">
                    <div class="mb-2">
                         <label for="revision-notes" class="block text-xs font-medium text-slate-600 mb-1">修改说明 (可选)</label>
                         <input type="text" id="revision-notes" class="w-full text-xs p-1.5 border border-slate-300 rounded-md focus:ring-1 focus:ring-blue-500">
                    </div>
                    <div class="flex justify-end space-x-2">
                        <button id="cancel-edit-btn" class="px-3 py-1.5 text-xs font-medium text-slate-700 bg-slate-200 hover:bg-slate-300 rounded-md">取消</button>
                        <button id="save-changes-btn" class="px-3 py-1.5 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">保存修改</button>
                        <button id="approve-result-btn" class="px-3 py-1.5 text-xs font-medium text-white bg-green-600 hover:bg-green-700 rounded-md">审核通过</button>
                    </div>
                </div>

                <div class="p-3 border-t border-slate-200 bg-slate-50/50 flex-shrink-0 max-h-48 overflow-y-auto custom-scrollbar">
                    <h3 class="text-sm font-semibold text-slate-600 mb-2">修改历史</h3>
                    <ul id="version-history-list" class="space-y-1.5 text-xs">
                        <li class="text-slate-500">加载中...</li>
                    </ul>
                </div>
            </div>

            <!-- Right Pane: Original Document -->
            <div id="right-pane" class="w-full md:w-1/2 bg-white rounded-lg shadow overflow-hidden flex flex-col pane-transition">
                <div class="p-3 border-b border-slate-200 bg-slate-50 flex justify-between items-center flex-shrink-0">
                    <h2 class="text-base font-semibold text-slate-700">原始文献</h2>
                    <div class="text-xs text-slate-500">
                        <button title="上一页" class="px-2 py-1 hover:bg-slate-200 rounded-md"><i class="fas fa-chevron-left"></i></button>
                        <span><span id="pdf-current-page">1</span> / <span id="pdf-total-pages">1</span></span>
                        <button title="下一页" class="px-2 py-1 hover:bg-slate-200 rounded-md"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="p-1 flex-grow custom-scrollbar overflow-auto">
                    <iframe id="original-doc-iframe" src="" class="w-full h-full border-none" title="Original Document"></iframe>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Mock data store (same as before)
        const mockResultDetailsStore = {
            "res001": { 
                name: "白芍文献1的有效成分及药理作用分析结果", 
                status: "approved", 
                originalDocUrl: "https://www.africau.edu/images/default/sample.pdf",
                currentVersion: "v1.1",
                versions: [
                    { version: "v1.1", date: "2025-02-16", editor: "张三", notes: "最终审核通过版", content: "详细分析结果内容 v1.1...\n- 白芍总苷具有抗炎、镇痛作用。\n- 主要成分包括芍药苷、羟基芍药苷等。", approved: true },
                    { version: "v1.0", date: "2025-02-15", editor: "李四", notes: "初步提取", content: "初步分析结果 v1.0...\n- 白芍的主要成分是A, B, C.", approved: false }
                ]
            },
            "res002": { 
                name: "白芍文献2的核心观点提炼", 
                status: "pending", 
                originalDocUrl: "https://www.clickdimensions.com/links/TestPDFfile.pdf",
                currentVersion: "v1.0",
                versions: [
                    { version: "v1.0", date: "2025-02-18", editor: "赵六", notes: "待审核版本", content: "文献核心观点：白芍在免疫调节方面有潜在应用价值。\n需要进一步实验验证。", approved: false }
                ]
            },
             "res003": { 
                name: "综述：IBD治疗中草药应用前景分析", 
                status: "rejected", 
                originalDocUrl: "https://www.clickdimensions.com/links/TestPDFfile.pdf",
                currentVersion: "v1.2",
                versions: [
                     { version: "v1.2", date: "2025-01-22", editor: "钱七", notes: "内容不充分，已驳回", content: "综述内容 v1.2... 数据支撑不足。", approved: false, rejected: true },
                     { version: "v1.1", date: "2025-01-21", editor: "孙八", notes: "修改后提交", content: "综述内容 v1.1... 补充了部分数据。", approved: false },
                     { version: "v1.0", date: "2025-01-20", editor: "孙八", notes: "初稿", content: "综述内容 v1.0...", approved: false }
                ]
            }
        };

        let currentResultId = null;
        let currentResultData = null;
        let displayedVersion = null; 
        let isEditMode = false;
        let isOriginalDocVisible = true;

        const resultMainTitle = document.getElementById('result-main-title');
        const resultStatusBadge = document.getElementById('result-status-badge');
        const resultVersionInfo = document.getElementById('result-version-info');
        const resultTextDisplay = document.getElementById('result-text-display');
        const resultTextEdit = document.getElementById('result-text-edit');
        const editSpecificActions = document.getElementById('edit-specific-actions');
        const revisionNotesInput = document.getElementById('revision-notes');
        const headerActionsButtons = document.getElementById('header-actions-buttons'); // Container for main buttons
        const versionHistoryList = document.getElementById('version-history-list');
        const originalDocIframe = document.getElementById('original-doc-iframe');
        const leftPane = document.getElementById('left-pane');
        const rightPane = document.getElementById('right-pane');
        const toggleOriginalDocBtn = document.getElementById('toggle-original-doc-btn');
        const toggleDocText = document.getElementById('toggle-doc-text');
        const toggleDocIcon = toggleOriginalDocBtn.querySelector('i');


        function getStatusBadgeHTML(status) {
            // ... (same as before)
            let badgeClass = '';
            let statusText = status;
            switch (status) {
                case 'pending': badgeClass = 'status-pending'; statusText = '待审核'; break;
                case 'approved': badgeClass = 'status-approved'; statusText = '审核通过'; break;
                case 'rejected': badgeClass = 'status-rejected'; statusText = '审核不通过'; break;
                default: badgeClass = 'bg-slate-200 text-slate-700'; break;
            }
            return `<span class="status-badge-lg ${badgeClass}">${statusText}</span>`;
        }

        function displayVersionContent(versionObj) {
            // ... (same as before)
             displayedVersion = versionObj;
            resultTextDisplay.textContent = versionObj.content;
            resultVersionInfo.textContent = `版本: ${versionObj.version} | 更新: ${versionObj.date} by ${versionObj.editor}`;
            if (versionObj.notes) {
                resultVersionInfo.textContent += ` | 说明: ${versionObj.notes}`;
            }
            
            if (isEditMode && versionObj.version !== currentResultData.versions[0].version) {
                toggleEditMode(false); 
            }
            resultTextEdit.value = versionObj.content; 
        }

        function renderVersionHistory() {
            // ... (same as before)
            versionHistoryList.innerHTML = '';
            currentResultData.versions.forEach(v => {
                const li = document.createElement('li');
                li.className = `p-1.5 rounded-md hover:bg-slate-100 cursor-pointer border-l-2 border-transparent version-item ${v.version === displayedVersion.version ? 'active' : ''}`;
                li.innerHTML = `
                    <div class="font-medium text-slate-700">版本 ${v.version} <span class="text-xs text-slate-500 font-normal">- ${v.date}</span></div>
                    ${v.notes ? `<div class="text-slate-500 truncate" title="${v.notes}">${v.notes}</div>` : ''}
                `;
                li.onclick = () => {
                    displayVersionContent(v);
                    document.querySelectorAll('#version-history-list .version-item').forEach(item => item.classList.remove('active'));
                    li.classList.add('active');
                };
                versionHistoryList.appendChild(li);
            });
        }
        
        function updateMainActions() {
            // Ensure only dynamic action buttons (Copy, Export, Review) are cleared and re-added
            // The toggle button is static in the HTML.
            const dynamicActionsContainer = document.getElementById('dynamic-actions-placeholder') || document.createElement('div');
            dynamicActionsContainer.id = 'dynamic-actions-placeholder';
            dynamicActionsContainer.className = 'flex items-center space-x-2'; // Match existing layout
            dynamicActionsContainer.innerHTML = ''; // Clear previous dynamic buttons

            const copyBtn = `<button id="copy-result-btn" title="复制当前结果内容" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md flex items-center"><i class="fas fa-copy mr-1.5"></i>复制</button>`;
            const exportBtn = `<button id="export-result-btn" title="导出当前结果" class="px-3 py-1.5 text-sm font-medium text-slate-700 bg-slate-100 hover:bg-slate-200 rounded-md flex items-center"><i class="fas fa-file-export mr-1.5"></i>导出</button>`;
            
            dynamicActionsContainer.innerHTML += copyBtn + exportBtn;

            if (currentResultData && currentResultData.status !== 'approved' && !isEditMode) {
                 const reviewBtn = `<button id="review-edit-btn" class="px-3 py-1.5 text-sm font-medium text-white bg-orange-500 hover:bg-orange-600 rounded-md flex items-center"><i class="fas fa-edit mr-1.5"></i>审核/编辑</button>`;
                 dynamicActionsContainer.innerHTML += reviewBtn;
            }
            
            // Prepend dynamic actions to the header actions container, before the static toggle button
            if (headerActionsButtons.firstChild && headerActionsButtons.firstChild.id === 'dynamic-actions-placeholder') {
                headerActionsButtons.replaceChild(dynamicActionsContainer, headerActionsButtons.firstChild);
            } else {
                headerActionsButtons.insertBefore(dynamicActionsContainer, toggleOriginalDocBtn);
            }

            // Re-attach listeners for newly created buttons
            if(document.getElementById('copy-result-btn')) {
                document.getElementById('copy-result-btn').onclick = () => { /* ... copy logic ... */ 
                    navigator.clipboard.writeText(resultTextDisplay.textContent)
                    .then(() => alert('结果内容已复制!'))
                    .catch(err => console.error('复制失败:', err));
                };
            }
            if(document.getElementById('export-result-btn')) {
                document.getElementById('export-result-btn').onclick = () => alert('导出功能 (占位)');
            }
            if(document.getElementById('review-edit-btn')) {
                 document.getElementById('review-edit-btn').onclick = () => toggleEditMode(true);
            }
        }

        function toggleEditMode(enable) {
            // ... (same as before, just ensure updateMainActions is called)
            isEditMode = enable;
            if (enable) {
                if (displayedVersion.version !== currentResultData.versions[0].version) {
                    alert("只能编辑最新版本的结果。");
                    isEditMode = false; 
                    return;
                }
                resultTextDisplay.classList.add('hidden');
                resultTextEdit.classList.remove('hidden');
                resultTextEdit.value = displayedVersion.content; 
                resultTextEdit.focus();
                editSpecificActions.classList.remove('hidden');
            } else {
                resultTextDisplay.classList.remove('hidden');
                resultTextEdit.classList.add('hidden');
                editSpecificActions.classList.add('hidden');
            }
            updateMainActions(); 
        }
        
        function toggleOriginalDocPane() {
            isOriginalDocVisible = !isOriginalDocVisible;
            if (isOriginalDocVisible) {
                rightPane.classList.remove('hidden', 'md:w-0', 'opacity-0');
                rightPane.classList.add('md:w-1/2');
                leftPane.classList.remove('md:w-full');
                leftPane.classList.add('md:w-1/2');
                toggleDocText.textContent = '隐藏原文';
                toggleDocIcon.classList.remove('fa-eye');
                toggleDocIcon.classList.add('fa-eye-slash');

            } else {
                rightPane.classList.add('hidden', 'md:w-0', 'opacity-0'); // 'hidden' for small screens, 'md:w-0' for transition
                rightPane.classList.remove('md:w-1/2');
                leftPane.classList.add('md:w-full');
                leftPane.classList.remove('md:w-1/2');
                toggleDocText.textContent = '显示原文';
                toggleDocIcon.classList.remove('fa-eye-slash');
                toggleDocIcon.classList.add('fa-eye');
            }
        }


        function loadResultDetails(resultId) {
            // ... (same as before, call updateMainActions)
            currentResultId = resultId;
            currentResultData = mockResultDetailsStore[resultId];

            if (!currentResultData) {
                resultMainTitle.textContent = "结果详情: 未找到";
                resultTextDisplay.textContent = "无法加载结果详情。";
                updateMainActions(); // Update even if data not found to clear buttons
                return;
            }

            resultMainTitle.textContent = `结果详情: ${currentResultData.name}`;
            resultStatusBadge.innerHTML = getStatusBadgeHTML(currentResultData.status);
            originalDocIframe.src = currentResultData.originalDocUrl || "about:blank";

            displayVersionContent(currentResultData.versions[0]); 
            renderVersionHistory();
            updateMainActions();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const resultIdFromUrl = urlParams.get('id');
            if (resultIdFromUrl) {
                loadResultDetails(decodeURIComponent(resultIdFromUrl));
            } else {
                resultMainTitle.textContent = "结果详情: 无效ID";
                updateMainActions(); // Clear buttons if no ID
            }

            toggleOriginalDocBtn.addEventListener('click', toggleOriginalDocPane);

            document.getElementById('cancel-edit-btn').onclick = () => toggleEditMode(false);
            
            document.getElementById('save-changes-btn').onclick = () => {
                // ... (save logic same as before)
                const newContent = resultTextEdit.value;
                const notes = revisionNotesInput.value || "内容更新";
                const currentDate = new Date().toISOString().split('T')[0];
                const currentUser = "当前用户"; 

                const latestVersionNum = parseFloat(currentResultData.versions[0].version.substring(1));
                const newVersionNum = (latestVersionNum + 0.1).toFixed(1);

                const newVersion = {
                    version: `v${newVersionNum}`,
                    date: currentDate,
                    editor: currentUser,
                    notes: notes,
                    content: newContent,
                    approved: false 
                };
                currentResultData.versions.unshift(newVersion); 
                currentResultData.currentVersion = newVersion.version;
                currentResultData.status = 'pending'; 

                mockResultDetailsStore[currentResultId] = currentResultData;

                displayVersionContent(newVersion);
                renderVersionHistory();
                resultStatusBadge.innerHTML = getStatusBadgeHTML(currentResultData.status);
                revisionNotesInput.value = '';
                toggleEditMode(false);
                alert('修改已保存，状态更新为待审核!');
            };

            document.getElementById('approve-result-btn').onclick = () => {
                // ... (approve logic same as before)
                 const latestVersionToApprove = currentResultData.versions[0]; // Always approve the absolute latest
                
                if (resultTextEdit.value !== latestVersionToApprove.content && isEditMode) {
                    if (!confirm("内容已修改但未保存。是否先保存更改再审核通过？\n点击 '确定' 保存并审核。\n点击 '取消' 以当前版本内容直接审核。")) {
                        // User chose to approve current (potentially edited but unsaved) content of THE LATEST version
                        latestVersionToApprove.content = resultTextEdit.value; // Capture unsaved edit before approving
                        latestVersionToApprove.notes = revisionNotesInput.value || "审核时直接更新内容并通过";
                    } else {
                        // Simulate save then approve by directly modifying the latest version
                         latestVersionToApprove.content = resultTextEdit.value;
                         latestVersionToApprove.notes = revisionNotesInput.value || "保存并审核通过";
                         // Version number doesn't change here, just content and approval status of the latest
                    }
                } else if (!isEditMode && resultTextDisplay.textContent !== latestVersionToApprove.content) {
                    // This case shouldn't happen if logic is correct, but as a safeguard
                    // This implies displayedVersion is not latestVersionToApprove, which approve shouldn't act on.
                    // Or that display got out of sync. For now, we assume approval always acts on currentResultData.versions[0]
                }

                latestVersionToApprove.approved = true;
                latestVersionToApprove.rejected = false; // Ensure not rejected
                latestVersionToApprove.date = new Date().toISOString().split('T')[0];
                latestVersionToApprove.editor = "审核人"; 
                currentResultData.status = 'approved';
                
                mockResultDetailsStore[currentResultId] = currentResultData;

                displayVersionContent(latestVersionToApprove);
                renderVersionHistory();
                resultStatusBadge.innerHTML = getStatusBadgeHTML(currentResultData.status);
                revisionNotesInput.value = '';
                toggleEditMode(false); 
                alert('结果已审核通过!');
            };
        });
    </script>
</body>
</html>